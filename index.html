<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor APS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js Plugin Datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos CSS -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Custom Styles (remaining styles are unchanged) */
        .chart-container-responsive {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 350px;
        }
        
        @media (min-width: 1024px) {
            .chart-container-responsive {
                height: 400px;
            }
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Animation for content switching */
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Setup Flow Styles */
        .setup-card {
            max-width: 420px;
            min-height: 350px;
        }
        
        .setup-flow-container {
             transition: opacity 0.5s ease-in-out;
        }
        
        .hidden-step {
            display: none !important;
        }

        /* Mobile specific adjustments for main content area */
        main {
             padding: 1rem; 
        }

        @media (min-width: 640px) { /* sm breakpoint */
            main {
                 padding: 2rem; 
            }
        }
        
        /* Fixa o cabe√ßalho da tabela POEPS na esquerda para rolagem horizontal */
        #view-poeps-annual-plan th.sticky, #view-poeps-annual-plan td.sticky {
            left: 0;
        }
        
        /* Ajuste do tamanho da fonte da tabela para caber mais informa√ß√£o */
        #view-poeps-annual-plan table {
            font-size: 0.8rem;
        }
        
        /* Estilo para a tabela de planejamento mensal */
        #poeps-monthly-plan-content table {
            font-size: 0.85rem;
            table-layout: fixed;
        }
        #poeps-monthly-plan-content th {
            font-size: 0.75rem; /* Ajuste para caber as colunas */
        }
        
        /* Estilo para a tabela de acompanhamento quadrimestral e PSE */
        .poeps-quarterly-table {
            width: 100%;
            border-collapse: collapse;
        }
        .poeps-quarterly-table th, .poeps-quarterly-table td {
            padding: 12px 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
            white-space: nowrap;
        }
        .poeps-quarterly-table th {
            background-color: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #4b5563;
        }
        .poeps-quarterly-table td {
            font-size: 0.875rem;
            color: #374151;
        }
        .poeps-quarterly-table .sticky-left {
            position: sticky;
            left: 0;
            z-index: 10;
        }
        .poeps-quarterly-table th.sticky-left {
            background-color: #eff6ff; /* Fundo diferente para a coluna fixa */
            font-size: 0.8rem;
            text-align: left;
            min-width: 250px;
        }
        .poeps-quarterly-table td.sticky-left {
            text-align: left;
            padding-left: 16px;
            background-color: #ffffff;
            font-weight: 500;
            min-width: 250px;
        }
        
        /* Estilo para a tabela de planejamento anual (muitas colunas) */
        .poeps-annual-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem; /* Menor fonte para caber mais */
        }
        .poeps-annual-table th, .poeps-annual-table td {
            padding: 8px 6px;
            border: 1px solid #e5e7eb;
            text-align: center;
            white-space: normal; /* Permite que o texto quebre */
        }
        .poeps-annual-table th {
            background-color: #eef2ff; /* Fundo azul claro para planejamento */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.65rem; /* Ainda menor para os cabe√ßalhos */
            color: #4338ca;
        }
        .poeps-annual-table td.indicator-cell {
            text-align: left;
            font-weight: 600;
            background-color: #ffffff;
            min-width: 180px;
        }
        .poeps-annual-table td.meta-cell {
            font-weight: 500;
            background-color: #f9fafb;
            min-width: 100px;
        }
        .poeps-annual-table th.sticky-left {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: #eef2ff;
        }
        .poeps-annual-table td.sticky-left {
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        /* Estilo para o manual de metodologia */
        .methodology-card {
            border-left-width: 4px;
        }
        /* Style for interactive methodology content */
        .methodology-nav-button {
            transition: all 0.2s;
            border-width: 2px;
        }
        .methodology-nav-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
    </style>

</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- FULLSCREEN SETUP FLOW (P√ÅGINA INICIAL) -->
    <div id="setup-flow" class="setup-flow-container fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="setup-card bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-11/12">
            <h1 class="text-2xl font-bold text-blue-700 mb-2">Monitor APS - Configura√ß√£o</h1>
            <p class="text-sm text-gray-500 mb-6 border-b pb-3">Selecione o contexto de monitoramento para iniciar o Dashboard.</p>
            
            <!-- STEP 1: MUNICIPALITY SELECTION & PASSWORD (Auth) -->
            <div id="step-municipality" class="step space-y-4">
                <label class="text-sm font-semibold text-gray-600 block">1. Selecione o Munic√≠pio</label>
                <div class="relative">
                    <select id="setup-municipality-select" onchange="currentMunicipalityId = this.value; document.getElementById('setup-municipio-password').focus();" class="w-full bg-gray-50 border border-gray-300 text-gray-700 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 appearance-none">
                        <option value="" disabled selected>-- Selecione um Munic√≠pio --</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                
                <label class="text-sm font-semibold text-gray-600 block pt-2">2. Insira a Senha de Acesso</label>
                <input type="password" id="setup-municipio-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="Senha de 6 d√≠gitos" onkeypress="if(event.key === 'Enter') attemptSetupLogin()">
                
                <p id="setup-auth-error" class="text-xs text-red-500 hidden">Senha incorreta ou munic√≠pio n√£o selecionado.</p>
                
                <div class="flex justify-end pt-4">
                    <button onclick="attemptSetupLogin()" id="btn-municipio-next" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Autenticar e Continuar</button>
                </div>
            </div>

            <!-- STEP 2: TEAM TYPE SELECTION -->
            <div id="step-team-type" class="step hidden-step space-y-4 fade-in">
                <label class="text-sm font-semibold text-gray-600 block">3. Selecione o Tipo de Equipe</label>
                <div class="relative">
                    <select id="setup-team-type-select" onchange="currentTeamType = this.value; populateTeamSelectorSetup(this.value);" class="w-full bg-gray-50 border border-gray-300 text-gray-700 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 appearance-none">
                        <option value="" disabled selected>-- Selecione o Tipo de Equipe --</option>
                        <option value="esf_eap">eSF / eAP (Sa√∫de da Fam√≠lia)</option>
                        <option value="esb">eSB (Sa√∫de Bucal)</option>
                        <option value="emulti">eMulti (Multiprofissional)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                <div class="flex justify-between pt-4">
                    <button onclick="switchStep('municipality')" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">Voltar</button>
                    <button onclick="nextStep('team-select')" id="btn-team-type-next" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Pr√≥ximo</button>
                </div>
            </div>

            <!-- STEP 3: SPECIFIC TEAM SELECTION -->
            <div id="step-team-select" class="step hidden-step space-y-4 fade-in">
                <label class="text-sm font-semibold text-gray-600 block">4. Selecione a Equipe Espec√≠fica</label>
                <div class="relative">
                    <select id="setup-team-select" onchange="currentTeamId = this.value;" class="w-full bg-gray-50 border border-gray-300 text-gray-700 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 appearance-none">
                        <option value="" disabled selected>-- Selecione a Equipe --</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></path></svg>
                    </div>
                </div>
                <div class="flex justify-between pt-4">
                    <button onclick="switchStep('team-type')" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">Voltar</button>
                    <button onclick="nextStep('program-select')" id="btn-team-select-next" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Pr√≥ximo</button>
                </div>
            </div>

             <!-- STEP 4: INCENTIVE PROGRAM SELECTION -->
            <div id="step-program-select" class="step hidden-step space-y-4 fade-in">
                <label class="text-sm font-semibold text-gray-600 block">5. Selecione o Programa de Incentivo</label>
                <div class="relative">
                    <select id="setup-incentive-program-select" onchange="loadIncentiveProgramSetup(this.value)" class="w-full bg-gray-50 border border-gray-300 text-gray-700 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 appearance-none">
                        <option value="cofinanciamento">Cofinanciamento Federal</option>
                        <option value="poeps">POEPS</option>
                        <option value="pse">PSE</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                
                <!-- STEP 5 (CONDICIONAL): COFINANCIAMENTO METRIC SELECTION -->
                <div id="setup-metric-sub-selector" class="space-y-2 hidden">
                    <label class="text-sm font-semibold text-gray-600 block">5.1. M√©trica do Cofinanciamento</label>
                    <div class="relative">
                         <select id="setup-cofinanciamento-view-select" onchange="currentCofinanciamentoView = this.value" class="w-full bg-gray-50 border border-gray-300 text-gray-700 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 appearance-none">
                            <option value="" disabled selected>-- Selecione a M√©trica --</option>
                            <!-- OP√á√ïES ATUALIZADAS -->
                            <option value="indicadores">Indicadores de Qualidade</option>
                            <option value="vinculo">V√≠nculo e Acompanhamento</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></path></svg>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between pt-4">
                    <button onclick="switchStep('team-select')" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">Voltar</button>
                    <button onclick="finalizeSetup()" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">Acessar Dashboard</button>
                </div>
            </div>
        </div>
    </div>


    <!-- DASHBOARD CONTAINER (Initially hidden) -->
    <div id="dashboard-container" class="h-full flex overflow-hidden hidden">
        <!-- SIDEBAR NAVIGATION -->
        <aside id="sidebar-nav" class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-10">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">M</div>
                <span class="font-bold text-xl tracking-tight text-gray-900">APS Monitor</span>
            </div>

            <div class="p-4">
                <!-- SELECTOR 1: MUNIC√çPIO (Permite re-sele√ß√£o, que for√ßa o retorno ao setup) -->
                <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 block">Munic√≠pio</label>
                <div class="relative mb-4">
                    <select id="municipality-select" onchange="handleMunicipalitySelection(this.value)" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 appearance-none">
                        <!-- Populated by JS on finalizeSetup -->
                    </select>
                     <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                
                <!-- SELECTOR 2: TIPO DE EQUIPE -->
                <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 block">Tipo de Equipe</label>
                <div class="relative mb-4">
                    <select id="team-type-select" onchange="loadTeamType(this.value)" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 appearance-none">
                    <option value="esf_eap">eSF / eAP (Sa√∫de da Fam√≠lia)</option>
                    <option value="esb">eSB (Sa√∫de Bucal)</option>
                    <option value="emulti">eMulti (Multiprofissional)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></path></svg>
                    </div>
                </div>

                <!-- SELECTOR 3: EQUIPE ESPEC√çFICA (INE) -->
                <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 block">Equipe Espec√≠fica (INE)</label>
                <div class="relative mb-4">
                    <select id="team-select" onchange="loadTeam(this.value)" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 appearance-none">
                        <!-- Populated by JS on finalizeSetup -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></path></svg>
                    </div>
                </div>
                
                <!-- SELECTOR 4: PROGRAMA DE INCENTIVO -->
                <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 block">Programa de Incentivo</label>
                <div class="relative mb-4">
                    <select id="incentive-program-select" onchange="loadIncentiveProgram(this.value)" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 appearance-none">
                        <!-- Populated/Restricted by JS -->
                        <option value="cofinanciamento">Cofinanciamento Federal</option>
                        <option value="poeps">POEPS</option>
                        <option value="pse">PSE</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></path></svg>
                    </div>
                </div>
                
                <!-- SELECTOR 5 (CONDICIONAL): M√âTRICA DO COFINANCIAMENTO -->
                <div id="cofinanciamento-sub-selector" class="space-y-2 mb-4 hidden">
                     <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 block">M√©trica do Cofinanciamento</label>
                    <div class="relative">
                        <select id="cofinanciamento-view-select" onchange="loadCofinanciamentoView(this.value)" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 appearance-none">
                            <!-- Populated/Restricted by JS -->
                            <option value="indicadores">Indicadores de Qualidade</option>
                            <option value="vinculo">V√≠nculo e Acompanhamento</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></path></svg>
                    </div>
                </div>

            </div>

            <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
                <!-- COFINANCIAMENTO / PADR√ÉO -->
                <!-- BOT√ÉO "VIS√ÉO GERAL" (Usado para Indicadores E V√≠nculo/Acomp.) -->
                <a href="#" onclick="switchView('overview')" id="nav-overview" class="nav-item bg-blue-50 text-blue-700 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                    <span id="label-nav-overview">üìä Vis√£o Geral</span>
                </a>
                
                <!-- BOT√ÉO DETALHAMENTO / A√á√ïES PSE -->
                <a href="#" onclick="switchView('details')" id="nav-details" class="nav-item text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                    <span id="label-nav-details">üîç Detalhamento (Indicadores)</span>
                </a>
                
                <!-- POEPS LINKS (Ocultos por padr√£o) -->
                <a href="#" onclick="switchView('poeps-monthly-plan')" id="nav-poeps-monthly-plan" class="nav-item hidden text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                    <span>üóìÔ∏è Planejamento Mensal</span>
                </a>
                <!-- NOVO BOT√ÉO: Avalia√ß√£o do Quadrimestre Atual -->
                <a href="#" onclick="switchView('poeps-quarterly-eval-current')" id="nav-poeps-quarterly-eval-current" class="nav-item hidden text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                    <span>‚≠ê Avalia√ß√£o do Quadrimestre Atual</span>
                </a>
                <a href="#" onclick="switchView('poeps-annual-plan')" id="nav-poeps-annual-plan" class="nav-item hidden text-gray-600 hover:bg-gray-50 hover:hover:text-gray-900 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                    <span>üìÖ Planejamento Anual</span>
                </a>
                <a href="#" onclick="switchView('poeps-monthly-eval')" id="nav-poeps-monthly-eval" class="nav-item hidden text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                    <span>üìù Avalia√ß√£o M√™s Anterior</span>
                </a>
                
                <!-- PSE -->
                <a href="#" onclick="switchView('pse')" id="nav-pse"
                    class="nav-item hidden text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-3 py-2 text-sm font-medium rounded-md">
                    <span>üè´ Programa Sa√∫de na Escola (PSE)</span>
                </a>
                
                <!-- BOT√ÉO DE VOLTAR PARA O MENU DE SELE√á√ÉO -->
                <a href="#" onclick="backToSetupMenu()" class="nav-item text-red-600 hover:bg-red-50 group flex items-center px-3 py-2 text-sm font-medium rounded-md mt-4 border-t border-gray-200 pt-3">
                    <span>‚Ü©Ô∏è Voltar para o Menu</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs text-gray-600">JS</div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Gestor APS</p>
                        <p class="text-xs text-gray-500">Logado</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto bg-gray-50 relative">
            <!-- Header -->
            <header class="bg-white shadow-sm sticky top-0 z-20 px-4 py-3 sm:px-8 sm:py-4 flex justify-between items-center">
                <div>
                    <!-- T√çTULO ATUALIZADO PARA 'Monitor APS' -->
                    <h1 class="text-lg sm:text-2xl font-bold text-gray-800">Monitor APS</h1>
                    <p class="text-xs sm:text-sm text-gray-500" id="header-context">Dados do Quadrimestre 3 / 2025 ‚Ä¢ Fonte: SISAB/e-SUS</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-semibold text-gray-900" id="header-program-name">Programa: Cofinanciamento Federal</p>
                        <!-- CLASSIFICA√á√ÉO GERAL - Condicionalmente oculta na Vis√£o Geral/Indicadores -->
                        <p class="text-xs font-medium" id="header-classification">Classifica√ß√£o Geral: --</p>
                    </div>
                    <!-- Mobile Menu Button (currently non-functional but maintained for structure) -->
                    <button class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </header>

            <!-- VIEW: OVERVIEW (Indicadores de Qualidade) -->
            <div id="view-overview" class="p-4 sm:p-8 space-y-4 sm:space-y-8 fade-in">
                <!-- Intro Paragraph -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-blue-800">Resumo da Equipe Selecionada</h3>
                    <p class="text-sm text-blue-700 mt-1" id="overview-intro-text">
                        Esta vis√£o consolida os indicadores de desempenho da equipe. Utilize o gr√°fico Radar para identificar o equil√≠brio entre as linhas de cuidado e o gr√°fico de Barras para comparar o desempenho com a meta.
                    </p>
                </div>

                <!-- Top Stats Grid (Forces 1 column on mobile, 3 on large screens) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6" id="stats-grid">
                    <!-- Cards s√£o gerados dinamicamente via JS (renderOverview) -->
                </div>

                <!-- Main Charts Section (Forces 1 column on mobile, 3 on large screens) -->
                <div class="grid grid-cols-1 lg:col-span-3 lg:grid-cols-3 gap-4 sm:gap-8" id="charts-section">
                    <!-- Bar Chart: Results vs Meta -->
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                        <!-- T√≠tulo alterado -->
                        <h3 class="font-bold text-gray-800 mb-4">Desempenho dos Indicadores</h3>
                        <div class="chart-container-responsive">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                    <!-- Radar Chart: Balance -->
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4">Equil√≠brio da Equipe </h3>
                        <p class="text-xs text-gray-500 mb-4">Visualiza√ß√£o da performance relativa entre as linhas de cuidado.</p>
                        <div class="chart-container-responsive" style="height: 300px;">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-semibold">Pontos fracos s√£o identificados pela proximidade ao centro.</span>
                        </div>
                    </div>
                </div>
                <!-- Message when charts are not available for eSB/eMulti -->
                <div id="no-chart-message" class="bg-gray-200 p-6 rounded-xl shadow-sm hidden">
                    <p class="text-center text-gray-600 font-semibold" id="no-chart-message-text">Gr√°ficos de Compara√ß√£o (Barra e Radar) dispon√≠veis apenas para os 7 Indicadores Principais (eSF/eAP).</p>
                    <p class="text-center text-sm text-gray-500 mt-2">Veja o desempenho nos cards de estat√≠sticas e no Detalhamento.</p>
                </div>
            </div>

            <!-- VIEW: DETAILS (The Core Interaction - Indicadores de Qualidade) -->
            <div id="view-details" class="p-4 sm:p-8 space-y-4 sm:space-y-6 hidden fade-in">
                 <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-indigo-500">
                    <h3 class="font-bold text-indigo-900">An√°lise Detalhada dos Indicadores</h3>
                    <p class="text-sm text-gray-600 mt-1">
                        Utilize os bot√µes de navega√ß√£o horizontal para analisar a mem√≥ria de c√°lculo, a nota metodol√≥gica e a sugest√£o de a√ß√£o para cada um dos indicadores da equipe <span id="detail-team-name" class="font-semibold">eSF Centro</span>.
                    </p>
                </div>

                <!-- Indicator Selector (Horizontal Scroll on Mobile - Critical for small screens) -->
                <div class="flex space-x-3 overflow-x-auto pb-4" id="indicator-nav">
                    <!-- Populated by JS -->
                </div>

                <!-- Active Indicator Detail Panel -->
                <div id="detail-panel" class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <!-- Header of Panel -->
                    <div class="bg-gray-50 px-4 py-4 sm:px-8 sm:py-6 border-b border-gray-200 flex justify-between items-start flex-col md:flex-row gap-4">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span id="detail-code" class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded">--</span>
                                <span id="detail-status" class="px-2 py-1 bg-gray-200 text-gray-800 text-xs font-bold rounded">--</span>
                            </div>
                            <h2 id="detail-title" class="text-xl sm:text-2xl font-bold text-gray-900">--</h2>
                        </div>
                        <!-- CART√ÉO DE RESULTADO ATUALIZADO COM ID PARA ESTILIZA√á√ÉO DIN√ÇMICA -->
                        <div id="detail-result-card" class="text-right p-3 rounded-lg border-2 shadow-sm w-full md:w-auto mt-3 md:mt-0">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Resultado Atual</p>
                            <p id="detail-result-big" class="text-3xl sm:text-4xl font-extrabold">--</p>
                        </div>
                    </div>

                    <!-- Content Grid (Forces 1 column on mobile, 2 on desktop) -->
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <!-- Left: The Math (Calculated from Context) -->
                        <div class="p-4 sm:p-8 border-b md:border-b-0 md:border-r border-gray-200">
                            <h4 class="font-bold text-gray-800 flex items-center gap-2 mb-4 sm:mb-6">
                                <span>üßÆ</span> Mem√≥ria de C√°lculo
                            </h4>
                            
                            <div class="space-y-4 sm:space-y-6">
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                    <p class="text-xs text-blue-600 uppercase font-semibold mb-1">Numerador</p>
                                    <p id="detail-num-desc" class="text-sm text-gray-700 mb-2">--</p>
                                    <p id="detail-num-val" class="text-xl sm:text-2xl font-mono font-bold text-blue-800">--</p>
                                </div>

                                <div class="flex justify-center text-gray-400 font-bold text-xl">√∑</div>

                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Denominador</p>
                                <p id="detail-den-desc" class="text-sm text-gray-700 mb-2">--</p>
                                <p id="detail-den-val" class="text-xl sm:text-2xl font-mono font-bold text-gray-800">--</p>
                                </div>
                            </div>
                            
                            <!-- C7 SUB-INDICADORES -->
                            <div id="detail-c7-subscores" class="mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-100 hidden">
                                <h5 class="font-semibold text-sm text-gray-900 mb-4">Componentes do C7 (Total de 100 Pontos)</h5>
                                <div id="c7-subscores-list" class="space-y-3">
                                    <!-- Subscores s√£o injetados aqui -->
                                </div>
                            </div>
                            <!-- FIM C7 SUB-INDICADORES -->

                            <div class="mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-100">
                                <h5 class="font-semibold text-sm text-gray-900 mb-2">Interpreta√ß√£o do Resultado</h5>
                                <p id="detail-interpretation" class="text-sm text-gray-600 leading-relaxed">
                                    --
                                </p>
                            </div>
                        </div>

                        <!-- Right: Methodology & Actions -->
                        <div class="p-4 sm:p-8 bg-gray-50/50">
                            <h4 class="font-bold text-gray-800 flex items-center gap-2 mb-4 sm:mb-6">
                                <span>üìö</span> Crit√©rios Metodol√≥gicos
                            </h4>
                            
                            <div class="space-y-4 sm:space-y-6">
                                <!-- Apenas Crit√©rios de Classifica√ß√£o permanece -->
                                <div> 
                                    <h5 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Crit√©rios de Classifica√ß√£o</h5>
                                    <ul id="detail-criteria" class="text-sm text-gray-600 space-y-2 list-disc list-inside bg-white p-3 rounded border border-gray-200">
                                        <!-- Populated by JS -->
                                    </ul>
                                </div>
                                
                                <!-- A√á√ïES ESTRAT√âGICAS (MOVIDO PARA AQUI) -->
                                <div> 
                                    <h5 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">A√ß√µes Estrat√©gicas</h5>
                                    <div id="detail-action-tip" class="bg-white p-3 rounded border border-gray-200 text-sm text-gray-700 leading-relaxed">
                                        <!-- Action Tip √© injetado aqui -->
                                    </div>
                                </div>
                                <!-- FIM A√á√ïES ESTRAT√âGICAS -->
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VIEW: VINCULO E ACOMPANHAMENTO -->
            <div id="view-vinculo" class="p-4 sm:p-8 space-y-4 sm:space-y-8 hidden fade-in">
                 <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-indigo-900">V√≠nculo e Acompanhamento Territorial</h3>
                    <p class="text-sm text-indigo-700 mt-1">
                        Esta m√©trica avalia a qualidade do cadastro e a continuidade do acompanhamento.
                    </p>
                </div>
                
                <!-- V√çNCULO (DIMENS√ÉO CADASTRO) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                        <h4 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                            <span>üîó</span> Dimens√£o V√≠nculo (Cadastro)
                        </h4>
                        <div id="vinculo-score-cad" class="text-right">
                             <p class="text-xs font-medium text-gray-500 uppercase">Escore Cadastro (M√°x. 3.00)</p>
                             <span id="vinculo-score-cad-val" class="text-2xl font-extrabold text-gray-900">--</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- N¬∫ de cadastros individuais -->
                        <div class="p-4 rounded-lg border border-gray-200 bg-gray-50">
                            <p class="text-sm text-gray-800 font-semibold">N¬∫ de Cadastros Individuais (Total)</p>
                            <p id="vinculo-cad-individual" class="text-2xl font-bold text-gray-600 mt-1">--</p>
                        </div>
                        <!-- Pessoas s√≥ com cadastro individual atualizado (MICI) -->
                        <div class="p-4 rounded-lg border border-blue-200 bg-blue-50">
                            <!-- TEXTO ATUALIZADO (mantido da altera√ß√£o anterior) -->
                            <p class="text-sm text-blue-800 font-semibold">Pessoas s√≥ com Cadastro Individual Atualizado</p>
                            <p id="vinculo-cad-individual-only" class="text-2xl font-bold text-blue-600 mt-1">--</p>
                        </div>
                        <!-- Pessoas com cadastro individual e domiciliar atualizados (MICI + MICDT) -->
                         <div class="p-4 rounded-lg border border-green-200 bg-green-50">
                            <!-- TEXTO ATUALIZADO (mantido da altera√ß√£o anterior) -->
                            <p class="text-sm text-green-800 font-semibold">Cadastro Completo e Atualizado (Individual + Domiciliar)</p>
                            <p id="vinculo-cad-complete" class="text-2xl font-bold text-green-600 mt-1">--</p>
                        </div>
                        <!-- Cadastros Desatualizados e/ou incompletos -->
                        <div class="p-4 rounded-lg border border-yellow-200 bg-yellow-50">
                            <!-- TEXTO ATUALIZADO (mantido da altera√ß√£o anterior) -->
                            <p class="text-sm text-yellow-800 font-semibold">Cadastros Desatualizados/Incompletos</p>
                            <p id="vinculo-cad-incomplete" class="text-2xl font-bold text-yellow-600 mt-1">--</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 rounded-xl border border-gray-200 bg-gray-50">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-2">An√°lise do Escore (Dimens√£o Cadastro)</p>
                         <p id="vinculo-resultado-cad" class="text-lg font-semibold text-gray-800">--</p>
                        <p id="vinculo-classificacao-cad" class="text-sm mt-1 font-bold">--</p>
                    </div>
                    
                </div>
                
                <!-- ACOMPANHAMENTO (DIMENS√ÉO ACOMPANHAMENTO) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                         <h4 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                            <span>üö∂</span> Dimens√£o Acompanhamento
                        </h4>
                        <div id="vinculo-score-acomp" class="text-right">
                             <p class="text-xs font-medium text-gray-500 uppercase">Escore Acompanhamento (M√°x. 7.00)</p>
                             <span id="vinculo-score-acomp-val" class="text-2xl font-extrabold text-gray-900">--</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Par√¢metro populacional -->
                        <div class="p-4 rounded-lg border border-gray-200 bg-gray-50">
                            <!-- TEXTO ALTERADO -->
                            <p class="text-sm text-gray-800 font-semibold">Par√¢metro Populacional</p>
                            <p id="acomp-parametro" class="text-2xl font-bold text-gray-600 mt-1">--</p>
                        </div>
                        <!-- N√∫mero de Pessoas Acompanhadas -->
                        <div class="p-4 rounded-lg border border-blue-200 bg-blue-50">
                             <!-- TEXTO ALTERADO -->
                            <p class="text-sm text-blue-800 font-semibold">Pessoas Acompanhadas</p>
                            <p id="acomp-pessoas-total" class="text-2xl font-bold text-blue-600 mt-1">--</p>
                        </div>
                    </div>
                    
                     <div class="mt-6 p-4 rounded-xl border border-gray-200 bg-gray-50">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-2">An√°lise do Escore (Dimens√£o Acompanhamento)</p>
                         <p id="acomp-resultado-acomp" class="text-lg font-semibold text-gray-800">--</p>
                        <p id="acomp-classificacao-acomp" class="text-sm mt-1 font-bold">--</p>
                    </div>

                </div>
                
                <!-- SCORE FINAL -->
                <div class="bg-indigo-600 text-white p-6 rounded-xl shadow-2xl flex justify-between items-center mt-6">
                    <div>
                        <p class="text-sm font-semibold uppercase opacity-80">Escore Final do Componente (Cadastro + Acompanhamento)</p>
                        <p id="vinculo-score-final-val" class="text-4xl font-extrabold mt-1">--</p>
                    </div>
                     <div class="text-right">
                        <p class="text-sm font-semibold uppercase opacity-80">Classifica√ß√£o Final</p>
                        <p id="vinculo-classificacao-final" class="text-4xl font-extrabold mt-1">--</p>
                    </div>
                </div>

            </div>
            
             <!-- VIEW: POEPS - Planejamento Mensal -->
            <div id="view-poeps-monthly-plan" class="p-4 sm:p-8 space-y-6 hidden fade-in">
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg">
                    <!-- T√≠tulo din√¢mico que ser√° atualizado no JS -->
                    <h3 class="font-bold text-indigo-900" id="poeps-monthly-plan-header">üóìÔ∏è Planejamento Mensal - POEPS</h3>
                    <p class="text-sm text-indigo-700 mt-1">Este √© o cronograma de a√ß√µes e metas para o m√™s atual</p>
                </div>
                
                <!-- NOVO CARD DE CAMPANHA -->
                <div id="poeps-campaign-card" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hidden">
                     <!-- Conte√∫do injetado por JS -->
                </div>
                
                <!-- Container para injetar a tabela -->
                <div id="poeps-monthly-plan-content" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                    <!-- Conte√∫do injetado por JS -->
                    <p class="text-center text-gray-500">Carregando planejamento mensal...</p>
                </div>
            </div>
            
            <!-- VIEW: POEPS - Avalia√ß√£o do Quadrimestre Atual (ATUALIZADA) -->
            <div id="view-poeps-quarterly-eval-current" class="p-4 sm:p-8 space-y-6 hidden fade-in">
                 <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-blue-900">‚≠ê Acompanhamento do Quadrimestre Atual - POEPS</h3>
                    <p class="text-sm text-blue-700 mt-1" id="poeps-quarterly-eval-intro">
                        Quadro de monitoramento da execu√ß√£o das metas do POEPS para o quadrimestre atual (<span id="poeps-quarterly-months">Setembro, Outubro, Novembro e Dezembro</span>). O status √© calculado com base no acumulado dos meses em rela√ß√£o √† Meta Quadrimestral.
                    </p>
                </div>
                 <div id="poeps-quarterly-eval-content" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                    <!-- Conte√∫do ser√° injetado por JS -->
                    <p class="text-center text-gray-500">Carregando dados de acompanhamento...</p>
                </div>
            </div>

            <!-- VIEW: POEPS - Planejamento Anual -->
            <div id="view-poeps-annual-plan" class="p-4 sm:p-8 space-y-6 hidden fade-in">
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-indigo-900">üìÖ Planejamento Anual - POEPS</h3>
                    <p class="text-sm text-indigo-700 mt-1">Visualiza√ß√£o Consolidado do planejamento anual da POEPS, conforme metas estabelecidas por quadrimestre</p>
                </div>
                 <div id="poeps-annual-plan-content" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                    <!-- Conte√∫do ser√° gerado dinamicamente por JS -->
                    <p class="text-center text-gray-500">Carregando planejamento anual...</p>
                </div>
            </div>

            <!-- VIEW: POEPS - Avalia√ß√£o M√™s Anterior -->
            <div id="view-poeps-monthly-eval" class="p-4 sm:p-8 space-y-6 hidden fade-in">
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-green-900">üìù Avalia√ß√£o do M√™s Anterior - POEPS</h3>
                    <p class="text-sm text-green-700 mt-1">An√°lise da execu√ß√£o das metas do POEPS para o m√™s de <span id="poeps-monthly-eval-month">Novembro</span>, comparando o realizado com o previsto no planejamento.</p>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <!-- Conte√∫do ser√° injetado por JS -->
                    <p class="text-center text-gray-500">Carregando relat√≥rio de execu√ß√£o...</p>
                </div>
            </div>
            
            <!-- VIEW: PSE -->
            <div id="view-pse" class="p-4 sm:p-8 space-y-6 hidden fade-in">

                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-green-900">üè´ Programa Sa√∫de na Escola (PSE)</h3>
                    <p class="text-sm text-green-700 mt-1">
                        Monitoramento das a√ß√µes pactuadas no √¢mbito do PSE para a equipe <span class="font-semibold" id="pse-current-team-name">--</span>.
                    </p>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                    <table class="min-w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-700 uppercase text-xs">
                                <th class="border px-3 py-2 text-left">Escola Pactuada</th>
                                <th class="border px-3 py-2 text-left">A√ß√£o</th>
                                <th class="border px-3 py-2 text-left">Respons√°vel</th>
                                <th class="border px-3 py-2 text-left">A√ß√µes do PSE Correspondentes</th>
                                <th class="border px-3 py-2 text-left">Registro</th>
                            </tr>
                        </thead>
                        <tbody id="pse-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: POEPS - Avalia√ß√£o Quadrimestre Anterior (REMOVIDO DA NAVEGA√á√ÉO, MANTIDO A VIEW CASO O USU√ÅRIO A BUSQUE DIRETAMENTE) -->
            <div id="view-poeps-quarterly-eval" class="p-4 sm:p-8 space-y-6 hidden fade-in">
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-green-900">üìù Avalia√ß√£o do Quadrimestre Anterior - POEPS</h3>
                    <p class="text-sm text-green-700 mt-1">Esta √© a avalia√ß√£o consolidada do desempenho da equipe no √∫ltimo quadrimestre em rela√ß√£o √†s metas do POEPS.</p>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">Relat√≥rio Quadrimestral Consolidado</h4>
                    <p class="text-sm text-gray-600">Conte√∫do a ser desenvolvido: An√°lise de impacto, resultados de longo prazo e revis√£o de estrat√©gias.</p>
                </div>
            </div>
            
            <!-- VIEW: INFORMA√á√ïES DO MUNIC√çPIO (REMOVIDO) -->

            <!-- Autorship Logo / Fixed Footer -->
             <div class="fixed bottom-4 right-4 z-30 opacity-90 transition-all duration-300 hover:opacity-100 flex flex-col items-end">
                <span class="text-xs font-semibold text-gray-700 bg-gray-200 px-3 py-1 rounded-t-lg shadow-sm">Autoria: J√∫lia Ribeiro</span>
                <!-- SUBSTITUA O VALOR 'src' ABAIXO PELA URL DIRETA DA SUA LOGO -->
                <img 
                    id="logo-autoria"
                    src="https://placehold.co/120x40/006B33/FFFFFF?text=Monitor+APS" 
                    alt="Logo Monitor APS" 
                    class="w-32 h-10 object-cover rounded-b-lg shadow-lg"
                    onerror="this.onerror=null; this.src='https://placehold.co/120x40/666666/FFFFFF?text=Monitor+APS';"
                >
            </div>

        </main>
    </div>

    
    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS ---
        const STATUS_COLORS = {
            '√ìtimo': { bg: 'bg-blue-100', text: 'text-blue-800', resultColor: 'text-blue-600', hex: '#3B82F6' },
            'Bom': { bg: 'bg-green-100', text: 'text-green-800', resultColor: 'text-green-600', hex: '#10B981' },
            'Suficiente': { bg: 'bg-yellow-100', text: 'text-yellow-800', resultColor: 'text-yellow-600', hex: '#F59E0B' },
            'Regular': { bg: 'bg-red-100', text: 'text-red-800', resultColor: 'text-red-600', hex: '#EF4444', metaColor: '#DC2626' }, // Adicionado metaColor
            'Cr√≠tico': { bg: 'bg-red-100', text: 'text-red-800', resultColor: 'text-red-600', hex: '#EF4444', metaColor: '#DC2626' }, 
            'Alcan√ßado': { bg: 'bg-green-100', text: 'text-green-800', resultColor: 'text-green-600', hex: '#10B981' }, 
            'N√£o Alcan√ßado': { bg: 'bg-red-100', text: 'text-red-800', resultColor: 'text-red-600', hex: '#EF4444' }, 
            'Acompanhamento': { bg: 'bg-yellow-100', text: 'text-yellow-800', resultColor: 'text-yellow-600', hex: '#F59E0B' }, 
            'N/A': { bg: 'bg-gray-100', text: 'text-gray-600', resultColor: 'text-gray-500', hex: '#D1D5DB' },
            'PENDING': { bg: 'bg-yellow-100', text: 'text-yellow-800', resultColor: 'text-yellow-600', hex: '#F59E0B' } // Novo status para verifica√ß√£o pendente
        };
        
        // --- CENTRALIZED INDICATOR METADATA (eSF, eSB, eMulti) ---
        const ESF_INDICATOR_METADATA = {
            "C1": { 
                title: "Mais Acesso", 
                meta: 50, 
                numDesc: "Consultas Agendadas", 
                denDesc: "Total de Atendimentos (Espont√¢nea + Programada)", 
                concept: "Verifica o percentual de acesso de demanda programada em rela√ß√£o ao total de demandas (espont√¢nea e programada). O ideal √© evitar os extremos, buscando equil√≠brio.", 
                // CRIT√âRIOS ATUALIZADOS CONFORME NOTA METODOL√ìGICA C1
                criteria: ["√ìtimo: > 50% e ‚â§ 70%", "Bom: > 30% e ‚â§ 50%", "Suficiente: > 10% e ‚â§ 30%", "Regular: ‚â§ 10% ou > 70%"],
                actionTipBase: "Revise a organiza√ß√£o da agenda. √â crucial reservar blocos hor√°rios para atendimento programado (cr√¥nicos, ciclos de vida) E garantir acolhimento ou atendimento imediato para demanda espont√¢nea.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS) com tipo de atendimento 'Programado' ou 'Demanda Espont√¢nea'.", "C√°lculo: (N¬∫ de Atendimentos Programados) / (N¬∫ Total de Atendimentos) x 100."],
            },
            "C2": { 
                title: "Cuidado no Desenv. Infantil", 
                meta: 75, 
                numDesc: "Crian√ßas com Boas Pr√°ticas (Vacinas, Consultas, Avalia√ß√µes)", 
                denDesc: "Crian√ßas Vinculadas (Est.)", 
                concept: "Avalia o acesso e monitoramento efetivo das crian√ßas at√© dois anos de idade, focando na cobertura vacinal (Polio e Penta) e realiza√ß√£o das consultas de puericultura.", 
                // CRIT√âRIOS ATUALIZADOS CONFORME NOTA METODOL√ìGICA C2
                criteria: ["√ìtimo: ‚â• 75%", "Bom: ‚â• 50% e < 75%", "Suficiente: ‚â• 25% e < 50%", "Regular: < 25%"],
                // NOVO CONTE√öDO PARA BOAS PR√ÅTICAS (C2)
                actionTipBase: `
                    <div class="p-3 bg-blue-50 border-l-4 border-blue-300 rounded-lg">
                        <h5 class="font-bold text-blue-800">Aten√ß√£o Priorit√°ria e Registro Corretos</h5>
                        <ul class="mt-2 text-sm text-gray-700 list-disc list-inside space-y-1">
                            <li><strong>Busca Ativa:</strong> Criar listas nominais das crian√ßas com esquema vacinal incompleto (Polio/Penta) ou com consultas de puericultura atrasadas (especialmente 0-2 anos) para busca ativa imediata.</li>
                            <li><strong>Monitoramento na Consulta:</strong> Em toda consulta de puericultura, verificar e registrar o estado vacinal (Polio e Penta), o n√∫mero total de consultas e a evolu√ß√£o do desenvolvimento.</li>
                            <li><strong>Registro de Consulta:</strong> Garantir que a Ficha de Atendimento Individual (e-SUS) seja preenchida corretamente, marcando a Condi√ß√£o Avaliada como 'Puericultura/Crescimento e Desenvolvimento'.</li>
                            <li><strong>Integra√ß√£o Sala de Vacina:</strong> Fortalecer o fluxo de comunica√ß√£o entre a equipe de Sa√∫de da Fam√≠lia e a sala de vacina para rastrear faltosos.</li>
                        </ul>
                    </div>
                `,
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS) com Condi√ß√£o de Avaliada ('Puericultura/Crescimento e Desenvolvimento') e CBO/Profissional. Registrar Vacinas (e-SUS Vacina√ß√£o).", "C√°lculo: (N¬∫ de Crian√ßas pontuadas) / (N¬∫ de Crian√ßas de 0 a 2 anos cadastradas) x 100."],
            },
            "C3": { 
                title: "Cuidado na Gesta√ß√£o e Puerp√©rio", 
                meta: 75, 
                numDesc: "Gestantes com Boas Pr√°ticas (6+ consultas, Exames, Odonto)", 
                denDesc: "Gestantes Vinculadas (Est.)", 
                concept: "Mede a qualidade do cuidado pr√©-natal, garantindo no m√≠nimo 6 consultas, exames de s√≠filis/HIV e atendimento odontol√≥gico, al√©m da consulta de puerp√©rio.", 
                // CRIT√âRIOS ATUALIZADOS CONFORME NOTA METODOL√ìGICA C3
                criteria: ["√ìtimo: ‚â• 75%", "Bom: ‚â• 50% e < 75%", "Suficiente: ‚â• 25% e < 50%", "Regular: < 25%"],
                actionTipBase: "Foco na capta√ß√£o precoce (at√© 12¬™ semana) e na garantia do atendimento odontol√≥gico. A falta de apenas um item (exames ou odonto) impede a pontua√ß√£o da gestante.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS) com Condi√ß√£o de Avaliada ('Pr√©-natal/Puerp√©rio') e Exames/Atendimento Odontol√≥gico registrados.", "C√°lculo: (N¬∫ de Gestantes pontuadas) / (N¬∫ de Gestantes cadastradas) x 100."],
            },
            "C4": { 
                title: "Cuidado da Pessoa com Diabetes", 
                meta: 75, 
                numDesc: "Diab√©ticos Pontuados (Consulta + HbA1c)", 
                denDesc: "Diab√©ticos Vinculados (Est.)", 
                concept: "Avalia o monitoramento semestral de pacientes com diabetes. O paciente deve ter pelo menos uma consulta e a solicita√ß√£o ou registro da Hemoglobina Glicada (HbA1c) no semestre.", 
                // CRIT√âRIOS ATUALIZADOS CONFORME NOTA METODOL√ìGICA C4
                criteria: ["√ìtimo: ‚â• 75%", "Bom: ‚â• 50% e < 75%", "Suficiente: ‚â• 25% e < 50%", "Regular: < 25%"],
                actionTipBase: "Crie listas de pacientes diab√©ticos com data da √∫ltima HbA1c. Utilize grupos operativos para rastrear os faltosos e agendar a coleta de exames e a consulta de reavalia√ß√£o.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Registrar a Condi√ß√£o Avaliada (Diabetes Mellitus) e solicitar/registrar o resultado da HbA1c (Hemoglobina Glicada).", "C√°lculo: (N¬∫ de Diab√©ticos pontuados) / (N¬∫ de Diab√©ticos cadastradas) x 100."],
            },
            "C5": { 
                title: "Cuidado da Pessoa com Hipertens√£o", 
                meta: 75, 
                numDesc: "Hipertensos Pontuados (Consulta + Aferi√ß√£o de PA)", 
                denDesc: "Hipertensos Vinculados (Est.)", 
                concept: "Mede o acompanhamento semestral de pacientes com hipertens√£o. O paciente deve ter pelo menos uma consulta e o registro da Aferi√ß√£o da Press√£o Arterial (PA) no semestre.", 
                // CRIT√âRIOS ATUALIZADOS CONFORME NOTA METODOL√ìGICA C5
                criteria: ["√ìtimo: ‚â• 75%", "Bom: ‚â• 50% e < 75%", "Suficiente: ‚â• 25% e < 50%", "Regular: < 25%"],
                actionTipBase: "Garantir o registro estruturado e correto da Press√£o Arterial (PA) em todos os atendimentos, mesmo os de triagem e acolhimento. A alta frequ√™ncia de monitoramento √© essencial para o controle.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Registrar a Condi√ß√£o Avaliada (Hipertens√£o Arterial Sist√™mica) e aferir/registrar a PA na se√ß√£o 'Dados Antropom√©tricos'.", "C√°lculo: (N¬∫ de Hipertensos pontuados) / (N¬∫ de Hipertensos cadastradas) x 100."],
            },
            "C6": { 
                title: "Cuidado da Pessoa Idosa", 
                meta: 75, 
                numDesc: "Idosos Pontuados (Avalia√ß√£o Multidimensional)", 
                denDesc: "Idosos Vinculados (Est.)", 
                concept: "Avalia o monitoramento efetivo do cuidado integral √† sa√∫de de pessoas idosas (‚â• 60 anos), com √™nfase na aplica√ß√£o de planos de cuidados ou avalia√ß√£o multidimensional (Ex: IVCF-20/VES-13).", 
                // CRIT√âRIOS ATUALIZADOS CONFORME NOTA METODOL√ìGICA C6
                criteria: ["√ìtimo: ‚â• 75%", "Bom: ‚â• 50% e < 75%", "Suficiente: ‚â• 25% e < 50%", "Regular: < 25%"],
                actionTipBase: "Foco na aplica√ß√£o da Avalia√ß√£o Multidimensional da Pessoa Idosa (AMPI). Priorize idosos fr√°geis, acamados ou com m√∫ltiplas comorbidades. O registro correto dos c√≥digos de avalia√ß√£o √© fundamental.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Registrar a Condi√ß√£o Avaliada (Pessoa Idosa em acompanhamento) e o C√≥digo da Avalia√ß√£o Multidimensional (Z00.0, Z00.8 ou similar).", "C√°lculo: (N¬∫ de Idosos com AMPI) / (N¬∫ de Idosos de 60+ cadastradas) x 100."],
            },
            "C7": { 
                title: "Cuidado da Mulher na Preven√ß√£o do C√¢ncer", 
                meta: 75, 
                numDesc: "Pontua√ß√£o Ponderada Total (Max: 100 pontos)", 
                denDesc: "Base de 100 Pontos (Pondera√ß√£o)", 
                concept: "M√©dia ponderada de quatro sub-indicadores de preven√ß√£o: Citopatol√≥gico (20%), Vacina HPV (30%), Consulta Mulher (30%) e Mamografia (20%) na popula√ß√£o alvo.", 
                // CRIT√âRIOS ATUALIZADOS CONFORME NOTA METODOL√ìGICA C7
                criteria: ["√ìtimo: ‚â• 75 pontos", "Bom: ‚â• 50 e < 75 pontos", "Suficiente: ‚â• 25 e < 50 pontos", "Regular: < 25 pontos"],
                actionTipBase: "Cr√≠tico: Realizar busca ativa das mulheres em atraso. Organizar 'Dia D' de rastreamento e garantir que os exames sejam realizados e registrados nos sistemas de informa√ß√£o.",
                registro: ["Registro: Combina√ß√£o de registros de Citopatol√≥gico, Vacina HPV, Consulta de Puerp√©rio e Mamografia em suas respectivas bases (e-SUS/SISAB, e-SUS Vacina√ß√£o, etc.).", "C√°lculo: M√©dia ponderada de 4 sub-indicadores de preven√ß√£o."],
            },
            // --- INDICADORES eSB (Bucal) ---
            "B1": { 
                title: "1¬™ Consulta Programada", meta: 5, // Atualizado para 5%
                numDesc: "N¬∫ de Primeiras Consultas Programadas", denDesc: "Popula√ß√£o de Abrang√™ncia (Est.)", 
                concept: "Avalia o acesso e o monitoramento efetivo da popula√ß√£o em rela√ß√£o aos cuidados de sa√∫de bucal, com incentivo √† capta√ß√£o precoce e acompanhamento coordenado e cont√≠nuo na APS. (Ref: Nota Metodol√≥gica B1)", 
                criteria: ["√ìtimo: > 5%", "Bom: > 3% e ‚â§ 5%", "Suficiente: > 1% e ‚â§ 3%", "Regular: ‚â§ 1%"],
                actionTipBase: "Intensifique a busca ativa, focando na capta√ß√£o precoce da popula√ß√£o (crian√ßas e gestantes) para o in√≠cio do acompanhamento odontol√≥gico. Utilize agendamento program√°tico.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS) com CBO de Cirurgi√£o-Dentista/ASB/TSB. O tipo de atendimento deve ser registrado como 'Primeira Consulta Odontol√≥gica Program√°tica'.", "C√°lculo: (N¬∫ de Primeiras Consultas Program√°ticas) / (Popula√ß√£o de Abrang√™ncia) x 100."],
            },
            "B2": { 
                title: "Tratamento Conclu√≠do (TC)", meta: 75,
                numDesc: "N¬∫ de Tratamentos Conclu√≠dos", denDesc: "N¬∫ de Pessoas com 1¬™ Consulta", 
                concept: "Avalia a resolutividade da eSB para garantir acesso oportuno e intervir na demanda que se apresenta a ela, mensurando a cobertura de tratamentos conclu√≠dos. (Ref: Nota Metodol√≥gica B2)", 
                criteria: ["√ìtimo: > 75% e ‚â§ 100%", "Bom: > 50% e ‚â§ 75%", "Suficiente: ‚â• 25% e < 50%", "Regular: ‚â§ 25%"],
                actionTipBase: "Revise os fluxos internos para evitar altas por 'abandono'. Garanta a conclus√£o do tratamento na pr√≥pria APS, priorizando o agendamento de retorno. O tratamento deve ser conclu√≠do em at√© 4 meses.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Registrar o C√≥digo de Desfecho como 'Tratamento Odontol√≥gico Conclu√≠do'.", "C√°lculo: (N¬∫ de Tratamentos Conclu√≠dos) / (N¬∫ de Primeiras Consultas Program√°ticas) x 100."],
            },
            "B3": { 
                title: "Taxa de Exodontia", meta: 8, // Atualizado para 8% (Piso √ìtimo)
                numDesc: "N¬∫ de Exodontias", denDesc: "Total de Procedimentos Individuais", 
                concept: "Avalia se o cirurgi√£o-dentista da eSB tem conseguido agir no in√≠cio da hist√≥ria da doen√ßa, ofertando menos procedimentos curativos/exodontia em rela√ß√£o ao total de procedimentos individuais ofertados. (Ref: Nota Metodol√≥gica B3)", 
                criteria: ["√ìtimo: ‚â• 8% e < 10%", "Bom: ‚â• 10% e < 12%", "Suficiente: ‚â• 12% e < 14%", "Regular: < 8% ou ‚â• 14% (Fora da Faixa Ideal)"],
                actionTipBase: "Reduza as extra√ß√µes, investindo em a√ß√µes preventivas, Tratamento Restaurador Atraum√°tico (ART) e em t√©cnicas de tratamento minimamente invasivas.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Contar todos os procedimentos com c√≥digo de Exodontia como numeradores. Contar todos os procedimentos individuais (preventivos e curativos) como denominadores.", "C√°lculo: (N¬∫ de Exodontias) / (N¬∫ Total de Procedimentos Individuais) x 100."],
            },
            "B4": { 
                title: "Escova√ß√£o Supervisionada (6-12a)", meta: 1.0, // Atualizado para 1.0%
                numDesc: "N¬∫ de Pessoas em A√ß√µes Coletivas", denDesc: "N¬∫ de Pessoas Vinculadas (Est.)", 
                concept: "Avalia a propor√ß√£o de crian√ßas em faixa et√°ria escolar (6 a 12 anos) beneficiadas pela a√ß√£o coletiva de escova√ß√£o dental supervisionada, incentivando a preven√ß√£o. (Ref: Nota Metodol√≥gica B4)", 
                criteria: ["√ìtimo: > 1%", "Bom: > 0,5% e ‚â§ 1%", "Suficiente: > 0,25% e ‚â§ 0,5%", "Regular: ‚â§ 0.25%"],
                actionTipBase: "Aumente a frequ√™ncia de a√ß√µes de Escova√ß√£o Supervisionada nas escolas. Garanta o registro correto destas atividades no e-SUS/Ficha de Atividade Coletiva.",
                registro: ["Registro: Ficha de Atividade Coletiva (e-SUS). Registrar a A√ß√£o como 'Escova√ß√£o dental supervisionada'. O p√∫blico-alvo deve ser Crian√ßas em faixa et√°ria escolar.", "C√°lculo: (N¬∫ de Crian√ßas 6-12a com escova√ß√£o supervisionada) / (N¬∫ de Crian√ßas 6-12a cadastradas) x 100."],
            },
            "B5": { 
                title: "Procedimentos Preventivos", meta: 80, // Atualizado para 80% (Piso √ìtimo)
                numDesc: "N¬∫ de Procedimentos Preventivos", denDesc: "N¬∫ Total de Procedimentos", 
                concept: "Mensura o total de procedimentos odontol√≥gicos individuais preventivos em rela√ß√£o ao total de procedimentos odontol√≥gicos individuais realizados, indicando prioriza√ß√£o da preven√ß√£o. (Ref: Nota Metodol√≥gica B5)", 
                criteria: ["√ìtimo: ‚â• 80% e ‚â§ 85%", "Bom: ‚â• 60% e < 80%", "Suficiente: ‚â• 40% e < 60%", "Regular: < 40% ou > 85% (Fora da Faixa Ideal)"],
                actionTipBase: "Priorize o agendamento e a realiza√ß√£o de procedimentos preventivos (como aplica√ß√£o de fl√∫or e selantes) nos atendimentos individuais, antes de partir para procedimentos curativos.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Contar todos os procedimentos preventivos (Ex: Aplica√ß√£o de Fl√∫or, Selantes) como numeradores. Contar todos os procedimentos individuais (preventivos e curativos) como denominadores.", "C√°lculo: (N¬∫ de Procedimentos Individuais Preventivos) / (N¬∫ Total de Procedimentos Individuais) x 100."],
            },
            "B6": { 
                title: "Tratamento Restaurador Atraum√°tico (ART)", meta: 8, // Atualizado para 8%
                numDesc: "N¬∫ de TRA/ART", denDesc: "N¬∫ Total de Procedimentos Restauradores", 
                concept: "Mede a propor√ß√£o de Tratamento Restaurador Atraum√°tico (ART) em rela√ß√£o ao total de procedimentos restauradores, incentivando t√©cnicas minimamente invasivas. (Ref: Nota Metodol√≥gica B6)", 
                criteria: ["√ìtimo: > 8%", "Bom: > 6% e ‚â§ 8%", "Suficiente: > 3% e ‚â§ 6%", "Regular: ‚â§ 3%"],
                actionTipBase: "Capacite a equipe para o uso da t√©cnica ART (restaura√ß√µes provis√≥rias, cimento de ion√¥mero de vidro) e garanta a disponibilidade de materiais.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Contar procedimentos ART como numeradores e todos os procedimentos restauradores como denominadores.", "C√°lculo: (N¬∫ de Procedimentos ART) / (N¬∫ Total de Procedimentos Restauradores) x 100."],
            },
            // --- INDICADORES eMulti (Matriciamento) ---
            "M1": { 
                title: "M√©dia Atendimentos/Pessoa", 
                meta: 3.0, // Fator - NOVO PISO √ìTIMO: > 3
                numDesc: "Total de Atendimentos (Individual + Coletivo)", 
                denDesc: "Total de Pessoas Acompanhadas pela eMulti (12 meses)", 
                concept: "Mensura a m√©dia de atendimentos por pessoa realizados pela eMulti na APS, expressando o acesso da popula√ß√£o a a√ß√µes de assist√™ncia. (Ref: Nota Metodol√≥gica M1)", 
                // CRIT√âRIOS ATUALIZADOS
                criteria: ["√ìtimo: > 3", "Bom: > 2 and ‚â§ 3", "Suficiente: > 1 and ‚â§ 2", "Regular: ‚â§ 1"],
                actionTipBase: "Melhore o fluxo de referenciamento e a capta√ß√£o de pacientes para acompanhamento cont√≠nuo pela eMulti (mais de 1 atendimento por quadrimestre). Fortale√ßa a comunica√ß√£o com a eSF/eAP.",
                registro: ["Registro: Ficha de Atendimento Individual e Ficha de Atividade Coletiva (e-SUS). Contar todos os atendimentos/participa√ß√µes como numeradores. O denominador √© o N¬∫ de Pessoas Distintas com pelo menos um atendimento.", "C√°lculo: (N¬∫ Total de Atendimentos) / (N¬∫ de Pessoas Distintas Acompanhadas)"],
            },
            "M2": { 
                title: "A√ß√µes Interprofissionais", 
                meta: 5, // Percentual - NOVO PISO √ìTIMO: > 5%
                numDesc: "N¬∫ de A√ß√µes Interprofissionais Compartilhadas (eMulti + eSF/eAP)", 
                denDesc: "N¬∫ Total de A√ß√µes Realizadas pela eMulti", 
                concept: "Monitora a propor√ß√£o de a√ß√µes voltadas para o cuidado centrado na pessoa realizadas de forma compartilhada (Apoio Matriciamento) entre a eMulti e as equipes da APS. (Ref: Nota Metodol√≥gica M2)", 
                // CRIT√âRIOS ATUALIZADOS
                criteria: ["√ìtimo: > 5%", "Bom: > 2.5% and ‚â§ 5%", "Suficiente: > 1% and ‚â§ 2.5%", "Regular: ‚â§ 1%"],
                actionTipBase: "Aumente a frequ√™ncia das reuni√µes de Apoio Matriciamento e das a√ß√µes conjuntas com as equipes de sa√∫de da fam√≠lia vinculadas. O registro correto √© crucial.",
                registro: ["Registro: Ficha de Atendimento Individual (e-SUS). Utilizar o campo 'A√ß√µes Interprofissionais' ou registrar o atendimento como 'Matriciamento' / 'Discuss√£o de Caso'. O denominador √© o N¬∫ Total de A√ß√µes da eMulti.", "C√°lculo: (N¬∫ de A√ß√µes Interprofissionais Compartilhadas) / (N¬∫ Total de A√ß√µes da eMulti) x 100."],
            }
        };


        // --- POEPS INDICATOR METADATA (NOVO) ---
        const POEPS_INDICATOR_METADATA = [
            { id: 1, title: "Pr√°ticas Corporais / Atividade F√≠sica", key: "Indicador 01 - Pr√°ticas Corporais e atividade f√≠sica", target: 3190, unit: 'participantes', description: "Participantes totais no m√™s", targetText: "Atingir 4% da popula√ß√£o SUS dependente por m√™s - 3190" },
            { id: 2, title: "Educa√ß√£o em Sa√∫de", key: "Indicador 02 - Educa√ß√£o em Sa√∫de", target: 35, unit: 'a√ß√µes', description: "02 por equipe no m√™s", targetText: "5x o n√∫mero de equipes - 35" },
            { id: 3, title: "Marcadores de Consumo Alimentar", key: "Indicador 03 - Marcadores de consumo alimentar", target: 783, unit: 'registros', description: "Avaliar/Registrar Dados", targetText: "Atingir 3% da popula√ß√£o geral - 783" },
            { id: 4, title: "Comit√™ de Pol√≠ticas de Equidades", key: "Indicador 04 - Comit√™ de Pol√≠ticas de Equidades", target: 4, unit: 'a√ß√µes', description: "01 A√á√ÉO OBRIGAT√ìRIA / m√™s", targetText: "4 A√ß√µes Obrigat√≥rias" }, // 1 a√ß√£o por m√™s * 4 meses = 4 a√ß√µes obrigat√≥rias
            { id: 5, title: "Acompanhamento do estado nutricional", key: "Indicador 05 - Peso e altura", target: 8351, unit: 'mensura√ß√µes', description: "Realizar 265 mensura√ß√µes por equipe no m√™s", targetText: "Atingir 32% da popula√ß√£o geral - 8.351 pessoas" },
            { id: 6, title: "Orienta√ß√£o Sexual / Identidade de G√™nero", key: "Indicador 06 - Atualiza√ß√£o dos cadastro com orienta√ß√£o sexual e identidade de g√™nero", target: 'Aumentar 1,2%', unit: 'atualiza√ß√µes', description: "Realizar o m√°ximo de atualiza√ß√µes", targetText: "Aumentar em 1,75%" }, // N√£o num√©rico simples, usa status Acompanhamento
            { id: 7, title: "Atendimento Individuais √† Pessoas Pretas e Pardas", key: "Indicador 07 - Atendimentos √† Pessoas Pretas e Pardas", target: 'Aumentar', unit: '%', description: "5% dos atendimentos totais no m√™s", targetText: "Aumentar a propor√ß√£o de atendimentos no quadrimestre" }, // N√£o num√©rico simples, usa status Acompanhamento
            { id: 8, title: "PICS", key: "Indicador 08 - PICS", target: 110, unit: 'procedimentos', description: "Realizar 28 Procedimentos de PICS no m√™s", targetText: "110 Procedimentos / Quadrimestre" } 
        ];

        // Map the indicator ID to its specific mock data key
        const POEPS_Q_EVAL_MAP = {
            1: "Indicador 01 - Pr√°ticas Corporais e atividade f√≠sica", 
            2: "Indicador 02 - Educa√ß√£o em Sa√∫de",                   
            3: "Indicador 03 - Marcadores de consumo alimentar",     
            4: "Indicador 04 - Comit√™ de Pol√≠ticas de Equidades",    
            5: "Indicador 05 - Peso e altura",                      
            6: "Indicador 06 - Atualiza√ß√£o dos cadastro com orienta√ß√£o sexual e identidade de g√™nero", 
            7: "Indicador 07 - Atendimentos √† Pessoas Pretas e Pardas", 
            8: "Indicador 08 - PICS",                               
        };
        
        // --- DADOS DO PDF (AVALIA√á√ÉO DO M√äS ANTERIOR - NOVEMBRO) ---
        const MOCK_POEPS_MONTHLY_EVAL = {
            month: "Novembro", // M√™s que est√° sendo avaliado
            year: 2025,
            // Valores baseados na planilha do PDF (Indicadores 1-8)
            indicators: [
                { id: 1, title: "Pr√°ticas Corporais / Atividade F√≠sica", meta: "1.357", realized: "241", fulfilled: false, pending: "1.116 (Diferen√ßa)" }, 
                { id: 2, title: "Educa√ß√£o em Sa√∫de", meta: "7", realized: "0", fulfilled: false, pending: "7 A√ß√µes" }, 
                { id: 3, title: "Marcadores de Consumo Alimentar", meta: "203", realized: "203", fulfilled: true, pending: "0" }, 
                { id: 4, title: "Comit√™ de Pol√≠ticas de Equidades", meta: "1 A√ß√£o Obrigat√≥ria", realized: "VERIFICAR", fulfilled: 'PENDING', pending: "Verifica√ß√£o pendente" }, 
                { id: 5, title: "Acompanhamento do estado nutricional", meta: "1.770", realized: "1.709", fulfilled: false, pending: "61 (Diferen√ßa)" }, 
                { id: 6, title: "Orienta√ß√£o Sexual / Identidade de G√™nero", meta: "Aumentar em 1,2%", realized: "Houve Aumento e Qualifica√ß√£o dos cadastros", fulfilled: true, pending: "Manter monitoramento" }, 
                { id: 7, title: "Atendimento Individuais √† Pessoas Pretas e Pardas", meta: "Aumentar atendimentos em 5%", realized: "N√£o foi poss√≠vel verificar", fulfilled: 'PENDING', pending: "Revisar fluxo de registro" }, 
                { id: 8, title: "PICS", meta: "28", realized: "164", fulfilled: true, pending: "0" } 
            ]
        };


        // --- DADOS DO CSV (ACOMPANHAMENTO POEPS QUADRIMESTRAL) ---
        // Simula√ß√£o do parse do CSV anexado para o 3¬∫ Quadrimestre (Setembro, Outubro, Novembro, Dezembro)
        const MOCK_POEPS_Q_EVAL = {
            "Indicador 01 - Pr√°ticas Corporais e atividade f√≠sica": {
                meta: 3190, set: 272, out: 205, nov: 241, dez: 0
            },
            "Indicador 02 - Educa√ß√£o em Sa√∫de": {
                meta: 35, set: 5, out: 16, nov: 0, dez: 0
            },
            "Indicador 03 - Marcadores de consumo alimentar": {
                meta: 783, set: 374, out: 298, nov: 203, dez: 0
            },
            "Indicador 05 - Peso e altura": {
                meta: 8351, set: 2909, out: 1912, nov: 1709, dez: 0
            },
            "Indicador 06 - Atualiza√ß√£o dos cadastro com orienta√ß√£o sexual e identidade de g√™nero": {
                meta: "Aumentar 1,2%", set: "719 ID / 168 OS", out: "704 ID / 167 OS", nov: "686 ID / 168 OS", dez: "N/A"
            },
            "Indicador 08 - PICS": {
                meta: 110, set: 210, out: 161, nov: 164, dez: 0
            },
            // Dados Mock para Indicadores 04 e 07, que n√£o est√£o na planilha mas precisam estar no quadro
            "Indicador 04 - Comit√™ de Pol√≠ticas de Equidades": {
                meta: 4, set: 1, out: 1, nov: 1, dez: 0 // 1 a√ß√£o por m√™s
            },
            "Indicador 07 - Atendimentos √† Pessoas Pretas e Pardas": {
                meta: "Aumentar", set: "4.5%", out: "4.8%", nov: "5.1%", dez: "N/A" // Dados mock em %
            }
        };
        
        const POEPS_PLANNING_DATA_CAMANDUCAIA_GLOBAL = [
             { id: 1, indicator: "Pr√°ticas Corporais / Atividade F√≠sica", metaAnual: "9.564 Participantes Anuais",
                jan: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                fev: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                mar: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                abr: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                mai: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                jun: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                jul: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                ago: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                set: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                out: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                nov: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
                dez: { tema: "Realiza√ß√£o de atividades fisicas no m√™s - Meta de 797 Participantes POR M√äS", responsavel: "Toda a Equipe" },
            },
            { id: 2, indicator: "02 A√ß√µes de Educa√ß√£o em Sa√∫de por equipe no m√™s", metaAnual: "100% de Equipes com 12 A√ß√µes/Ano",
                jan: { tema: "Tema: SA√öDE MENTAL / TEMA", responsavel: "Toda a Equipe" },
                fev: { tema: "Tema: C√¢ncer / TEMA", responsavel: "Toda a Equipe" },
                mar: { tema: "Tema: C√¢ncer Colorretal / TEMA", responsavel: "Toda a Equipe" },
                abr: { tema: "Tema: Autismo / TEMA", responsavel: "Toda a Equipe" },
                mai: { tema: "Tema: Doa√ß√£o de Sangue / TEMA", responsavel: "Toda a Equipe" },
                jun: { tema: "Tema: DSTs / TEMA", responsavel: "Toda a Equipe" },
                jul: { tema: "Tema: Hepatites Virais / TEMA", responsavel: "Toda a Equipe" },
                ago: { tema: "Tema: Aleitamento Materno / TEMA", responsavel: "Toda a Equipe" },
                set: { tema: "Tema: Preven√ß√£o ao Suic√≠dio / TEMA", responsavel: "Toda a Equipe" },
                out: { tema: "Tema: Outubro Rosa / TEMA", responsavel: "Toda a Equipe" },
                nov: { tema: "Tema: Novembro Azul / TEMA", responsavel: "Toda a Equipe" },
                dez: { tema: "Tema: HIV/AIDS / TEMA", responsavel: "Toda a Equipe" },
            },
            { id: 3, indicator: "Registros de Marcadores de Consumo Alimentar (MCA) - 3% da pop. geral", metaAnual: "100% de Cobertura do VIGITEL",
                jan: { tema: "Aplicar Inqu√©rito (1/4)", responsavel: "Nutricionista" },
                fev: { tema: "Aplicar Inqu√©rito (2/4)", responsavel: "Nutricionista" },
                mar: { tema: "Aplicar Inqu√©rito (3/4)", responsavel: "Nutricionista" },
                abr: { tema: "Aplicar Inqu√©rito (4/4)", responsavel: "Nutricionista" },
                mai: { tema: "Revis√£o de Dados", responsavel: "Nutricionista" },
                jun: { tema: "Revis√£o de Dados", responsavel: "Nutricionista" },
                jul: { tema: "Revis√£o de Dados", responsavel: "Nutricionista" },
                ago: { tema: "Revis√£o de Dados", responsavel: "Nutricionista" },
                set: { tema: "Revis√£o Quadrimestral", responsavel: "Nutricionista" },
                out: { tema: "Reuni√£o de Equipe", responsavel: "Nutricionista" },
                nov: { tema: "Reuni√£o de Equipe", responsavel: "Nutricionista" },
                dez: { tema: "Avalia√ß√£o Final", responsavel: "Nutricionista" },
            },
            { id: 4, indicator: "01 A√ß√£o Obrigat√≥ria de Equidades por m√™s", metaAnual: "4 A√ß√µes Obrigat√≥rias e 4 A√ß√µes Essenciais / Ano",
                jan: { tema: "AVALIA√á√ÉO ANTERIOR E PLANEJAMENTO DA PR√ìXIMA", responsavel: "Coordenador/Apoiador" },
                fev: { tema: "Fazer uma atividade de SENSIBILIZA√á√ÉO COM A EQUIPE sobre o COMIT√ä DE EQUIDADES e a elabora√ß√£o do DIAGN√ìSTICO SITUACIONAL", responsavel: "Coordenador/Apoiador" },
                mar: { tema: "ELABORAR E ENTREGAR O DIAGN√ìSTICO SITUACIONAL DO MUNIC√çPIO", responsavel: "Coordenador/Apoiador" },
                abr: { tema: "Entregar Diagn√≥stico Situacional", responsavel: "Coordenador/Apoiador" },
                mai: { tema: "Reuni√£o de Equipe", responsavel: "Coordenador/Apoiador" },
                jun: { tema: "Reuni√£o de Equipe", responsavel: "Coordenador/Apoiador" },
                jul: { tema: "Reuni√£o de Equipe", responsavel: "Coordenador/Apoiador" },
                ago: { tema: "Reuni√£o de Equipe", responsavel: "Coordenador/Apoiador" },
                set: { tema: "Revis√£o Quadrimestral", responsavel: "Coordenador/Apoiador" },
                out: { tema: "Reuni√£o de Equipe", responsavel: "Coordenador/Apoiador" },
                nov: { tema: "Reuni√£o de Equipe", responsavel: "Coordenador/Apoiador" },
                dez: { tema: "Avalia√ß√£o Final", responsavel: "Coordenador/Apoiador" },
            },
            { id: 5, indicator: "Acompanhamento do estado nutricional (Peso e Altura) - 32% da Pop. Geral", metaAnual: "8.351 Avalia√ß√µes Anuais",
                jan: { tema: "Avalia√ß√£o Antropom√©trica de 112 pessoas por equipe", responsavel: "Toda a Equipe" },
                fev: { tema: "Avalia√ß√£o Antropom√©trica de 112 pessoas por equipe", responsavel: "Toda a Equipe" },
                mar: { tema: "Avalia√ß√£o Antropom√©trica de 112 pessoas por equipe", responsavel: "Toda a Equipe" },
                abr: { tema: "Avalia√ß√£o Antropom√©trica de 205 pessoas por equipe", responsavel: "Toda a Equipe" },
                mai: { tema: "Avalia√ß√£o Antropom√©trica de 205 pessoas por equipe", responsavel: "Toda a Equipe" },
                jun: { tema: "Avalia√ß√£o Antropom√©trica de 205 pessoas por equipe", responsavel: "Toda a Equipe" },
                jul: { tema: "Avalia√ß√£o Antropom√©trica de 205 pessoas por equipe", responsavel: "Toda a Equipe" },
                ago: { tema: "Avalia√ß√£o Antropom√©trica de 205 pessoas por equipe", responsavel: "Toda a Equipe" },
                set: { tema: "Avalia√ß√£o Antropom√©trica de 300 pessoas por equipe", responsavel: "Toda a Equipe" },
                out: { tema: "Avalia√ß√£o Antropom√©trica de 300 pessoas por equipe", responsavel: "Toda a Equipe" },
                nov: { tema: "Avalia√ß√£o Antropom√©trica de 300 pessoas por equipe", responsavel: "Toda a Equipe" },
                dez: { tema: "Avalia√ß√£o Antropom√©trica de 300 pessoas por equipe", responsavel: "Toda a Equipe" },
            },
            { id: 6, indicator: "Preenchimentos de \"Orienta√ß√£o Sexual\" e \"Identidade de G√™nero\" no cadastro", metaAnual: "Aumentar em 1,75% no quadrimestre",
                jan: { tema: "Capacita√ß√£o", responsavel: "Toda a Equipe" },
                fev: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                mar: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                abr: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                mai: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                jun: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                jul: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                ago: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                set: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                out: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                nov: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
                dez: { tema: "Monitoramento Cadastral", responsavel: "Toda a Equipe" },
            },
            { id: 7, indicator: "Atendimento Individuais √† Pessoas Pretas e Pardas - 5% dos atendimentos totais", metaAnual: "Aumentar a propor√ß√£o de atendimentos no quadrimestre",
                jan: { tema: "Capacita√ß√£o", responsavel: "Toda a Equipe" },
                fev: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                mar: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                abr: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                mai: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                jun: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                jul: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                ago: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                set: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                out: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                nov: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
                dez: { tema: "Monitoramento Registro", responsavel: "Toda a Equipe" },
            },
            { id: 8, indicator: "PICS (Pr√°ticas Integrativas e Complementares em Sa√∫de) - 28 Procedimentos no m√™s", metaAnual: "336 Procedimentos/Ano",
                jan: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                fev: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                mar: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                abr: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                mai: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                jun: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                jul: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                ago: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                set: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                out: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                nov: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
                dez: { tema: "Realizar 28 Procedimentos de PICS no m√™s", responsavel: "Profissionais Certificados" },
            }
        ];

        const POEPS_PLANNING_DATA = {
            "camanducaia_poeps": POEPS_PLANNING_DATA_CAMANDUCAIA_GLOBAL
        };
        
        // --- MOCK DE CAMPANHAS DE SA√öDE MENSAIS (Mantido) ---
        const MONTHLY_CAMPAIGNS = {
            'janeiro': { theme: 'Janeiro Branco', desc: 'Sa√∫de Mental: Cuidado e Preven√ß√£o. / Janeiro Roxo (Hansen√≠ase e Doen√ßas)' },
            'fevereiro': { theme: 'Fevereiro Roxo/Laranja', desc: 'Conscientiza√ß√£o sobre L√∫pus, Alzheimer, Fibromialgia e Leucemia.' },
            'mar√ßo': { theme: 'Mar√ßo Amarelo/Azul-Marinho', desc: 'Endometriose e Preven√ß√£o do C√¢ncer Colorretal.' },
            'abril': { theme: 'Abril Azul/Verde', desc: 'Conscientiza√ß√£o sobre o Autismo e Seguran√ßa no Trabalho.' },
            'maio': { theme: 'Maio Amarelo', desc: 'Seguran√ßa no Tr√¢nsito e Luta contra o C√¢ncer de Melanoma.' },
            'junho': { theme: 'Junho Vermelho', desc: 'Incentivo √† Doa√ß√£o de Sangue.' },
            'julho': { theme: 'Julho Amarelo', desc: 'Luta contra as Hepatites Virais e C√¢ncer √ìsseo.' },
            'agosto': { theme: 'Agosto Dourado', desc: 'Incentivo ao Aleitamento Materno.' },
            'setembro': { theme: 'Setembro Amarelo', desc: 'Preven√ß√£o ao Suic√≠dio e Valoriza√ß√£o da Vida.' },
            'outubro': { theme: 'Outubro Rosa', desc: 'Preven√ß√£o e Diagn√≥stico Precoce do C√¢ncer de Mama e Colo de √ötero.' },
            'novembro': { theme: 'Novembro Azul', desc: 'Preven√ß√£o e Combate ao C√¢ncer de Pr√≥stata e Diabetes.' },
            'dezembro': { theme: 'Dezembro Vermelho', desc: 'Preven√ß√£o e Combate √† AIDS/HIV e outras ISTs.' }
        };


        // --- GLOBAL STATE ---
        // Alterado para iniciar vazio e for√ßar o fluxo de setup
        let currentMunicipalityId = ''; 
        let currentTeamType = '';
        let currentTeamId = '';
        let currentIncentiveProgram = ''; 
        let currentCofinanciamentoView = ''; 
        let currentIndicatorIndex = 0;
        let chartInstances = {};
        
        // Registrar o plugin datalabels globalmente
        Chart.register(ChartDataLabels);


        // --- SETUP FLOW LOGIC (Mantido) ---

        /**
         * Inicializa o fluxo de setup populando o seletor de munic√≠pios.
         */
        function initializeSetupFlow() {
            const setupSelect = document.getElementById('setup-municipality-select');
            setupSelect.innerHTML = '<option value="" disabled selected>-- Selecione um Munic√≠pio --</option>'; // Garante o placeholder
            
            Object.keys(municipalityData).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = municipalityData[id].name;
                setupSelect.appendChild(option);
            });
            
            // Garante que o dashboard est√° oculto e o setup est√° vis√≠vel
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('setup-flow').classList.remove('hidden');
            
            // Garante que o primeiro passo est√° vis√≠vel
            document.querySelectorAll('.step').forEach(step => step.classList.add('hidden-step'));
            document.getElementById('step-municipality').classList.remove('hidden-step');
            document.getElementById('setup-municipality-select').value = ''; // Reseta sele√ß√£o
        }


        /**
         * Alterna entre os passos do setup.
         * @param {string} stepId - O ID do passo a ser exibido.
         */
        function switchStep(stepId) {
            document.querySelectorAll('.step').forEach(step => step.classList.add('hidden-step'));
            document.getElementById(`step-${stepId}`).classList.remove('hidden-step');
            
            // Limpa mensagens de erro
            document.getElementById('setup-auth-error').classList.add('hidden');

            // Foco para melhor UX
            if (stepId === 'municipality') {
                 document.getElementById('setup-municipality-select').focus();
            } else if (stepId === 'team-type') {
                 document.getElementById('setup-team-type-select').focus();
            } else if (stepId === 'team-select') {
                 document.getElementById('setup-team-select').focus();
            } else if (stepId === 'program-select') {
                 document.getElementById('setup-incentive-program-select').focus();
            }
        }
        
        /**
         * Simula a fun√ß√£o alert() com uma mensagem de erro no fluxo.
         * @param {string} message - A mensagem a ser exibida.
         */
        function alertMessage(message) {
            const errorElement = document.getElementById('setup-auth-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => errorElement.classList.add('hidden'), 5000);
        }

        /**
         * Tenta autenticar o usu√°rio no primeiro passo do setup.
         */
        function attemptSetupLogin() {
            const select = document.getElementById('setup-municipality-select');
            const passwordInput = document.getElementById('setup-municipio-password');

            const municipalityId = select.value;
            const selectedMunicipality = municipalityData[municipalityId];
            const password = passwordInput.value;

            if (!selectedMunicipality) {
                alertMessage("Por favor, selecione um munic√≠pio.");
                return;
            }

            // Simula√ß√£o de autentica√ß√£o: Senha de 6 d√≠gitos deve ser igual ao mock.
            if (password !== selectedMunicipality.password || password.length !== 6) {
                alertMessage("Senha de 6 d√≠gitos incorreta.");
                passwordInput.value = ''; // Limpa a senha
                return;
            }

            // Autentica√ß√£o bem-sucedida
            currentMunicipalityId = municipalityId;
            // Define o tipo de equipe padr√£o do munic√≠pio para pr√©-sele√ß√£o
            currentTeamType = selectedMunicipality.defaultTeamType; 
            
            // Avan√ßa para a sele√ß√£o de Tipo de Equipe (Step 2)
            const teamTypeSelect = document.getElementById('setup-team-type-select');
            teamTypeSelect.value = currentTeamType; // Pr√©-seleciona o tipo padr√£o
            
            // Limpa o erro e avan√ßa
            document.getElementById('setup-auth-error').classList.add('hidden');
            switchStep('team-type');
        }

        /**
         * Avan√ßa para o pr√≥ximo passo no fluxo de setup (com valida√ß√£o).
         * @param {string} nextStepId - O ID do pr√≥ximo passo a ser exibido.
         */
        function nextStep(nextStepId) {
            
            if (nextStepId === 'team-select') {
                const teamTypeSelect = document.getElementById('setup-team-type-select');
                currentTeamType = teamTypeSelect.value;
                if (!currentTeamType) {
                    alertMessage("Por favor, selecione um Tipo de Equipe.");
                    return;
                }
                // Popula o seletor de equipes antes de avan√ßar e pr√©-seleciona a primeira
                const teamData = municipalityData[currentMunicipalityId].teams[currentTeamType];
                populateTeamSelectorSetup(teamData); 
                currentTeamId = Object.keys(teamData)[0]; // Pr√©-seleciona o primeiro INE
                
            } else if (nextStepId === 'program-select') {
                const teamSelect = document.getElementById('setup-team-select');
                currentTeamId = teamSelect.value;
                 if (!currentTeamId) {
                    alertMessage("Por favor, selecione uma Equipe Espec√≠fica.");
                    return;
                }
                 
                // --- NOVO: REGRAS ESPEC√çFICAS PARA ESB/eMulti NO SETUP ---
                const programSelect = document.getElementById('setup-incentive-program-select');
                const metricSelect = document.getElementById('setup-cofinanciamento-view-select');
                const subSelector = document.getElementById('setup-metric-sub-selector');


                if (currentTeamType === 'esb' || currentTeamType === 'emulti') {
                     currentIncentiveProgram = 'cofinanciamento';
                     currentCofinanciamentoView = 'indicadores';
                     
                     // Restringe as op√ß√µes para ESB/eMulti
                     programSelect.innerHTML = '<option value="cofinanciamento">Cofinanciamento Federal</option>';
                     programSelect.value = currentIncentiveProgram;
                     
                     metricSelect.innerHTML = '<option value="indicadores">Indicadores de Qualidade</option>';
                     metricSelect.value = currentCofinanciamentoView;
                     
                     // O sub-selector deve estar vis√≠vel pois o programa √© Cofinanciamento
                     subSelector.classList.remove('hidden');
                } else {
                     // Restaura as op√ß√µes padr√£o para eSF/eAP
                     currentIncentiveProgram = 'cofinanciamento';
                     currentCofinanciamentoView = 'indicadores';
                     
                     programSelect.innerHTML = `
                         <option value="cofinanciamento">Cofinanciamento Federal</option>
                         <option value="poeps">POEPS</option>
                         <option value="pse">PSE</option>`;
                     metricSelect.innerHTML = `
                         <option value="" disabled selected>-- Selecione a M√©trica --</option>
                         <option value="indicadores">Indicadores de Qualidade</option>
                         <option value="vinculo">V√≠nculo e Acompanhamento</option>`;
                         
                     // Set default selections
                     programSelect.value = currentIncentiveProgram;
                     loadIncentiveProgramSetup(currentIncentiveProgram); 
                     metricSelect.value = currentCofinanciamentoView;
                }


            }
            
            // Limpa o erro e avan√ßa
            document.getElementById('setup-auth-error').classList.add('hidden');
            switchStep(nextStepId);
        }
        
        /**
         * Popula o seletor de Equipes (Step 3) baseado no Tipo de Equipe selecionado (Step 2).
         * @param {object} teams - Objeto de equipes.
         */
        function populateTeamSelectorSetup(teams) {
            const teamSelect = document.getElementById('setup-team-select');
            teamSelect.innerHTML = ''; 

            const teamsList = Object.entries(teams);

            if (teamsList.length > 0) {
                teamsList.forEach(([ine, team]) => {
                    const option = document.createElement('option');
                    option.value = ine;
                    option.textContent = team.teamName;
                    teamSelect.appendChild(option);
                });
                 // Pr√©-seleciona a primeira equipe
                 teamSelect.value = teamsList[0][0]; 
            } else {
                 const option = document.createElement('option');
                 option.value = "";
                 option.textContent = `Nenhuma equipe encontrada.`;
                 option.disabled = true;
                 teamSelect.appendChild(option);
            }
        }
        
        /**
         * Mostra/Esconde o seletor de m√©trica se o programa selecionado for Cofinanciamento.
         * Esta fun√ß√£o √© chamada ao MUDAR O PROGRAMA na TELA DE SETUP.
         * @param {string} programId - O ID do programa selecionado.
         */
        function loadIncentiveProgramSetup(programId) {
             currentIncentiveProgram = programId;
             const subSelector = document.getElementById('setup-metric-sub-selector');
             
             // Define a restri√ß√£o baseada no tipo de equipe atual
             const isRestricted = currentTeamType === 'esb' || currentTeamType === 'emulti';
             
             if (programId === 'cofinanciamento') {
                 subSelector.classList.remove('hidden');
                 const metricSelect = document.getElementById('setup-cofinanciamento-view-select');
                 
                 if (isRestricted) {
                     // Restringe as op√ß√µes para ESB/eMulti
                     metricSelect.innerHTML = '<option value="indicadores">Indicadores de Qualidade</option>';
                     metricSelect.value = 'indicadores';
                     currentCofinanciamentoView = 'indicadores';
                 } else if (metricSelect.options.length < 2) {
                     // Caso tenha sido restringido anteriormente e agora √© eSF/eAP, restaura
                     metricSelect.innerHTML = `
                        <option value="indicadores">Indicadores de Qualidade</option>
                        <option value="vinculo">V√≠nculo e Acompanhamento</option>
                    `;
                 }
                 
             } else {
                 subSelector.classList.add('hidden');
                 currentCofinanciamentoView = 'indicadores'; // Define um padr√£o seguro
             }
        }


        /**
         * Finaliza o Setup, esconde o modal e exibe o Dashboard.
         */
        function finalizeSetup() {
            const programSelect = document.getElementById('setup-incentive-program-select');
            currentIncentiveProgram = programSelect.value;
            
            // 1. Valida√ß√£o Final (Verifica se a m√©trica foi selecionada, se necess√°rio)
            if (!currentIncentiveProgram) {
                alertMessage("Por favor, selecione o Programa de Incentivo.");
                return;
            }
            
            if (currentIncentiveProgram === 'cofinanciamento') {
                const cofinanciamentoSelect = document.getElementById('setup-cofinanciamento-view-select');
                currentCofinanciamentoView = cofinanciamentoSelect.value;
                 if (!currentCofinanciamentoView) {
                    alertMessage("Por favor, selecione a M√©trica do Cofinanciamento.");
                    return;
                }
            } else {
                 currentCofinanciamentoView = 'indicadores'; // Define um padr√£o seguro
            }
            
            // 2. Esconde Setup e Mostra Dashboard
            document.getElementById('setup-flow').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');

            // 3. Popula o Sidebar do Dashboard e Carrega a View
            populateDashboardSidebar();
            
            // Inicializa a view correta com base nas sele√ß√µes
            let initialView = 'overview';
            
            if (currentIncentiveProgram === 'poeps') {
                 initialView = 'poeps-monthly-eval'; // Inicia na Avalia√ß√£o Mensal
            } else if (currentIncentiveProgram === 'pse') {
                 initialView = 'pse'; // NOVO: Inicia na view PSE
            }
            
            switchView(initialView);
        }


        /**
         * Popula os seletores do Sidebar do Dashboard com os valores selecionados no Setup,
         * aplicando restri√ß√µes de eSB/eMulti.
         */
        function populateDashboardSidebar() {
            const data = getActiveData();

            // A. Munic√≠pio
            const muniSelectDash = document.getElementById('municipality-select');
            muniSelectDash.innerHTML = ''; 
            Object.keys(municipalityData).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = municipalityData[id].name;
                if (id === currentMunicipalityId) {
                    option.selected = true;
                }
                muniSelectDash.appendChild(option);
            });
            
            // B. Tipo de Equipe
            document.getElementById('team-type-select').value = currentTeamType;

            // C. Equipe Espec√≠fica (INE)
            const teamSelectDash = document.getElementById('team-select');
            teamSelectDash.innerHTML = ''; 
            const teamsInMunicipality = municipalityData[currentMunicipalityId].teams;
            const teamsList = teamsInMunicipality && teamsInMunicipality[currentTeamType] ? teamsInMunicipality[currentTeamType] : {};
            
            Object.entries(teamsList).forEach(([ine, team]) => {
                const option = document.createElement('option');
                option.value = ine;
                option.textContent = team.teamName; 
                if (ine === currentTeamId) {
                    option.selected = true;
                }
                teamSelectDash.appendChild(option);
            });
            
            // D. Programa de Incentivo
            const programSelectDash = document.getElementById('incentive-program-select');
            programSelectDash.innerHTML = ''; // Limpa antes de popular/restringir
            
            const isRestricted = currentTeamType === 'esb' || currentTeamType === 'emulti';

            if (isRestricted) {
                programSelectDash.innerHTML = '<option value="cofinanciamento">Cofinanciamento Federal</option>';
            } else {
                programSelectDash.innerHTML = `
                    <option value="cofinanciamento">Cofinanciamento Federal</option>
                    <option value="poeps">POEPS</option>
                    <option value="pse">PSE</option>
                `;
            }
            programSelectDash.value = currentIncentiveProgram;
            
            // E. M√©trica de Cofinanciamento (Condicional)
            const cofinanciamentoContainerDash = document.getElementById('cofinanciamento-sub-selector');
            const cofinanciamentoSelectDash = document.getElementById('cofinanciamento-view-select');
            cofinanciamentoSelectDash.innerHTML = '';
            
            if (currentIncentiveProgram === 'cofinanciamento') {
                cofinanciamentoContainerDash.classList.remove('hidden');
                
                if (isRestricted) {
                    // Restri√ß√£o: Apenas Indicadores de Qualidade para eSB/eMulti
                     cofinanciamentoSelectDash.innerHTML = '<option value="indicadores">Indicadores de Qualidade</option>';
                     currentCofinanciamentoView = 'indicadores'; // Garante o estado
                } else {
                    // Op√ß√µes completas para eSF/eAP
                     cofinanciamentoSelectDash.innerHTML = `
                        <option value="indicadores">Indicadores de Qualidade</option>
                        <option value="vinculo">V√≠nculo e Acompanhamento</option>
                    `;
                }
                cofinanciamentoSelectDash.value = currentCofinanciamentoView;
                
            } else {
                 cofinanciamentoContainerDash.classList.add('hidden');
            }
            
            updateSidebarNav();
        }
        
        /**
         * Lida com a sele√ß√£o de munic√≠pio no Dashboard. Se for diferente do atual, for√ßa o retorno ao setup.
         * @param {string} municipalityId - O ID do munic√≠pio selecionado.
         */
        function handleMunicipalitySelection(municipalityId) {
            if (municipalityId !== currentMunicipalityId) {
                backToSetupMenu(true);
            }
        }
        
        /**
         * For√ßa o retorno ao menu de setup (primeira tela).
         * @param {boolean} [showReauth=false] - Se deve mostrar uma mensagem de reautentica√ß√£o.
         */
        function backToSetupMenu(showReauth = false) {
             // 1. Alterna visualiza√ß√£o
             document.getElementById('dashboard-container').classList.add('hidden');
             document.getElementById('setup-flow').classList.remove('hidden');
             
             // 2. Reseta o setup para o primeiro passo
             switchStep('municipality');

             // 3. Opcional: Mostra mensagem de reautentica√ß√£o
             const errorElement = document.getElementById('setup-auth-error');
             if (showReauth) {
                 errorElement.textContent = "Munic√≠pio alterado. Por favor, reautentique com a senha de acesso.";
                 errorElement.classList.remove('hidden');
             } else {
                 errorElement.classList.add('hidden');
             }
             
             // 4. Limpa inputs de senha e foca
             document.getElementById('setup-municipio-password').value = '';
             document.getElementById('setup-municipality-select').focus();
        }

        // --- UTILS ---
        function getActiveData() {
            const munData = municipalityData[currentMunicipalityId];
            if (!munData) return null;
            
            const teamTypeData = munData.teams[currentTeamType];
            if (!teamTypeData) return null;

            let teamData = teamTypeData[currentTeamId];
            if (!teamData) {
                // Tenta carregar o primeiro do tipo se o ID espec√≠fico n√£o for encontrado (seguran√ßa)
                const firstTeamId = Object.keys(teamTypeData)[0];
                currentTeamId = firstTeamId;
                teamData = teamTypeData[currentTeamId];
            }
            
            if (!teamData || !teamData.indicators) {
                 return {
                    ...munData,
                    ...teamData,
                    indicators: []
                };
            }
            
            return {
                ...munData,
                ...teamData,
                indicators: teamData.indicators
            };
        }
        
        /**
         * Retorna o nome do m√™s atual em portugu√™s (primeira letra mai√∫scula).
         */
        function getCurrentMonthName() {
            const date = new Date();
            const options = { month: 'long' };
            let monthName = date.toLocaleDateString('pt-BR', options);
            // Capitalize first letter
            return monthName.charAt(0).toUpperCase() + monthName.slice(1);
        }
        
        /**
         * Retorna o nome do m√™s atual em min√∫sculas (para uso no objeto MONTHLY_CAMPAIGNS).
         */
        function getCurrentMonthKey() {
            const date = new Date();
            const options = { month: 'long' };
            return date.toLocaleDateString('pt-BR', options).toLowerCase();
        }

        function updateHeader(data) {
            const teamTypeSelect = document.getElementById('team-type-select');
            const teamTypeLabel = teamTypeSelect.options[teamTypeSelect.selectedIndex].text;
            const programSelect = document.getElementById('incentive-program-select');
            const programLabel = programSelect.options[programSelect.selectedIndex]?.text || 'N/A';
            
            let programDisplay = programLabel;
            if (currentIncentiveProgram === 'cofinanciamento') {
                const cofinanciamentoSelect = document.getElementById('cofinanciamento-view-select');
                const selectedIndex = cofinanciamentoSelect.selectedIndex !== -1 ? cofinanciamentoSelect.selectedIndex : 0;
                // CORRE√á√ÉO: Usando a vari√°vel local cofinanciamentoSelect para evitar ReferenceError
                const metricLabel = cofinanciamentoSelect.options[selectedIndex]?.text || 'Indicadores de Qualidade'; 
                programDisplay += ` (${metricLabel})`;
            }
            
            document.getElementById('header-context').innerText = `Munic√≠pio: ${data.name} | Tipo: ${teamTypeLabel} | Equipe: ${data.teamName} ‚Ä¢ Q3/2025`;
            document.getElementById('header-program-name').innerText = `Programa: ${programDisplay}`;
            
            const classificationElement = document.getElementById('header-classification');
            
            // ATUALIZA√á√ÉO: Oculta a classifica√ß√£o geral para COFINANCIAMENTO, POEPS E PSE
            const isRestrictedProgram = currentIncentiveProgram === 'cofinanciamento' || currentIncentiveProgram === 'poeps' || currentIncentiveProgram === 'pse'; 

            if (isRestrictedProgram) {
                // OCULTA a classifica√ß√£o geral para Cofinanciamento, POEPS e PSE
                classificationElement.classList.add('hidden');
            } else {
                // MOSTRA a classifica√ß√£o para outros programas (se houver)
                classificationElement.classList.remove('hidden');
                classificationElement.innerText = `Classifica√ß√£o Geral: ${data.classification}`;
                classificationElement.className = `text-xs font-medium ${STATUS_COLORS[data.classification]?.resultColor}`;
            }
            
            // GR√ÅFICOS: AGORA INCLUI E-MULTI NA CONDI√á√ÉO
            const shouldShowCharts = 
                (currentTeamType === 'esf_eap' || currentTeamType === 'esb' || currentTeamType === 'emulti') && 
                currentIncentiveProgram === 'cofinanciamento' && 
                currentCofinanciamentoView === 'indicadores';

            const chartsSection = document.getElementById('charts-section');
            const noChartMessage = document.getElementById('no-chart-message');
            // const noChartMessageText = document.getElementById('no-chart-message-text'); // N√£o usado diretamente aqui

            if (shouldShowCharts) {
                chartsSection.classList.remove('hidden');
                noChartMessage.classList.add('hidden');
                
                // NOVO: Chama a fun√ß√£o de inicializa√ß√£o dos gr√°ficos
                const chartData = getChartData(data.indicators);
                initCharts(chartData, currentTeamType);
                
            } else {
                // Limpa e oculta os gr√°ficos se n√£o for a view correta
                if (chartInstances.barChart) chartInstances.barChart.destroy();
                if (chartInstances.radarChart) chartInstances.radarChart.destroy();
                chartsSection.classList.add('hidden');
                
                // Oculta a mensagem em todos os outros casos (outras views, POEPS, etc.)
                noChartMessage.classList.add('hidden');
            }
            
            const isIndicatorView = currentIncentiveProgram === 'cofinanciamento' && currentCofinanciamentoView === 'indicadores';
            const statsGrid = document.getElementById('stats-grid');
            if (isIndicatorView) {
                statsGrid.classList.remove('hidden');
            } else {
                statsGrid.classList.add('hidden');
            }
        }
        
        /**
         * Controla a visibilidade dos links de navega√ß√£o lateral com base no programa/tipo de equipe.
         */
        function updateSidebarNav() {
            // Get all navigation items, including the new POEPS ones
            const navItems = document.querySelectorAll('aside nav a.nav-item');
            const isPOEPS = currentIncentiveProgram === 'poeps';
            const isPSE = currentIncentiveProgram === 'pse';
            const isCofinanciamentoActive = currentIncentiveProgram === 'cofinanciamento';
            const isCofinanciamentoVinculo = isCofinanciamentoActive && currentCofinanciamentoView === 'vinculo';
            const isESF = currentTeamType === 'esf_eap';
            const isESB = currentTeamType === 'esb';
            const isEMULTI = currentTeamType === 'emulti';
            
            // POEPS links 
            const poepsNavIds = ['nav-poeps-monthly-plan', 'nav-poeps-quarterly-eval-current', 'nav-poeps-annual-plan', 'nav-poeps-monthly-eval'];
            
            // 1. Esconde todos os links de conte√∫do primeiro
            navItems.forEach(item => {
                const id = item.id;
                // Mant√©m o bot√£o de "Voltar" sempre vis√≠vel (se for o caso)
                if (!item.textContent.includes('Voltar para o Menu')) {
                    item.classList.add('hidden');
                }
                // Reseta labels modificadas
                if (id === 'nav-overview') item.querySelector('span').innerText = 'üìä Vis√£o Geral'; 
                if (id === 'nav-details') item.querySelector('span').innerText = 'üîç Detalhamento (Indicadores)';
            });
            
            // 2. Define quais links ser√£o exibidos
            if (isPOEPS) {
                // POEPS: Mostra apenas os links do POEPS
                // Restringe POEPS APENAS para Camanducaia (por falta de dados mock para outros)
                if (currentMunicipalityId === 'camanducaia') {
                    poepsNavIds.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
                }
            } else if (isCofinanciamentoActive) {
                // Cofinanciamento: Indicadores ou V√≠nculo
                
                // O bot√£o Vis√£o Geral sempre aparece para o Cofinanciamento, independente da m√©trica
                document.getElementById('nav-overview')?.classList.remove('hidden');
                
                // Detalhamento √© dispon√≠vel para eSF, eSB e eMulti, mas apenas na view de indicadores
                if (!isCofinanciamentoVinculo) {
                    if (isESF || isESB || isEMULTI) {
                         document.getElementById('nav-details')?.classList.remove('hidden');
                    }
                }
            } else if (isPSE) { 
                // PSE: Apenas o bot√£o PSE
                document.getElementById('nav-pse')?.classList.remove('hidden');
            }
        }
        
        // --- NAVIGATION LOGIC (Mantido) ---
        
        /**
         * Renderiza a navega√ß√£o horizontal dos indicadores para a tela de Detalhamento.
         * @param {object} data - Dados ativos da equipe.
         */
        function renderIndicatorNav(data) {
            const navContainer = document.getElementById('indicator-nav');
            const indicators = data.indicators;
            navContainer.innerHTML = '';
            
            // Se for PSE, n√£o renderiza o nav de indicadores
            if (currentIncentiveProgram === 'pse') {
                 navContainer.classList.add('hidden');
                 return;
            } else {
                 navContainer.classList.remove('hidden');
            }


            indicators.forEach((indicator, index) => {
                const isActive = index === currentIndicatorIndex;
                const statusColor = STATUS_COLORS[indicator.status];
                
                // Cor da borda baseada no status
                const borderColor = statusColor.hex;

                const button = document.createElement('button');
                
                // CORRE√á√ÉO: Removido o uso do JIT class syntax no className e mantido apenas o style.borderColor
                button.className = `
                    px-4 py-2 text-sm font-semibold rounded-lg shadow-sm border-2
                    transition-all duration-200 ease-in-out whitespace-nowrap
                    ${isActive ? `bg-white text-gray-800 scale-[1.03] shadow-md` : `bg-gray-100 hover:bg-gray-200 text-gray-600 border-gray-200`}
                `;
                button.style.borderColor = isActive ? borderColor : '#e5e7eb'; // Aplica a cor da borda condicionalmente
                button.style.color = isActive ? statusColor.resultColor : '#4b5563'; // Cor do texto condicionalmente
                
                button.textContent = `${indicator.cod} - ${indicator.title}`;
                button.onclick = () => loadIndicatorDetail(index);
                
                navContainer.appendChild(button);
            });
        }
        
        /**
         * Carrega os detalhes de um indicador espec√≠fico na view-details.
         * @param {number} index - √çndice do indicador na lista de `data.indicators`.
         */
        function loadIndicatorDetail(index) {
            currentIndicatorIndex = index;
            const data = getActiveData();
            const indicator = data.indicators[index];
            if (!indicator) return;

            // 1. Atualiza a navega√ß√£o
            renderIndicatorNav(data);

            // 2. Atualiza o Header
            document.getElementById('detail-code').textContent = indicator.cod;
            document.getElementById('detail-status').textContent = indicator.status;
            document.getElementById('detail-status').className = `px-2 py-1 text-xs font-bold rounded ${STATUS_COLORS[indicator.status].bg} ${STATUS_COLORS[indicator.status].text}`;
            document.getElementById('detail-title').textContent = indicator.title;

            // 3. Atualiza o Card de Resultado
            const resultCard = document.getElementById('detail-result-card');
            // CORRE√á√ÉO: Remove o uso do JIT class syntax no className e usa style.borderColor
            resultCard.className = `text-right p-3 rounded-lg border-2 shadow-sm w-full md:w-auto mt-3 md:mt-0`; 
            resultCard.style.borderColor = STATUS_COLORS[indicator.status].hex; // Aplica a cor da borda via style
            
            document.getElementById('detail-result-big').textContent = indicator.displayResult;
            document.getElementById('detail-result-big').className = `text-3xl sm:text-4xl font-extrabold ${STATUS_COLORS[indicator.status].resultColor}`;

            // 4. Atualiza a Mem√≥ria de C√°lculo
            document.getElementById('detail-num-desc').textContent = indicator.numDesc;
            document.getElementById('detail-num-val').textContent = typeof indicator.num === 'number' ? indicator.num.toLocaleString('pt-BR') : indicator.num;
            document.getElementById('detail-den-desc').textContent = indicator.denDesc;
            document.getElementById('detail-den-val').textContent = typeof indicator.den === 'number' ? indicator.den.toLocaleString('pt-BR') : indicator.den;
            
            // 5. Atualiza o bloco de interpreta√ß√£o
            document.getElementById('detail-interpretation').textContent = indicator.concept;

            // 6. Atualiza Crit√©rios
            document.getElementById('detail-criteria').innerHTML = indicator.criteria.map(c => `<li class="ml-4">${c}</li>`).join('');

            // 7. Atualiza A√ß√µes Estrat√©gicas
            const actionTipContainer = document.getElementById('detail-action-tip');
            if (indicator.cod === 'C2' && indicator.action.includes('<div')) {
                actionTipContainer.innerHTML = indicator.action; // Se for C2, injeta o HTML completo
            } else {
                actionTipContainer.textContent = indicator.action;
            }
            
            // 8. L√≥gica C7 (Sub-indicadores)
            const c7SubscoresDiv = document.getElementById('detail-c7-subscores');
            const c7SubscoresList = document.getElementById('c7-subscores-list');
            
            if (indicator.cod === 'C7' && indicator.subScores && indicator.subScores.length > 0) {
                 c7SubscoresDiv.classList.remove('hidden');
                 c7SubscoresList.innerHTML = '';
                 
                 indicator.subScores.forEach(sub => {
                     const subColor = STATUS_COLORS[sub.status].text;
                     const subBg = STATUS_COLORS[sub.status].bg;
                     
                     c7SubscoresList.innerHTML += `
                         <div class="p-3 ${subBg} rounded-lg border border-gray-200">
                             <div class="flex justify-between items-center">
                                 <p class="text-xs font-semibold text-gray-600">${sub.name} (Peso ${sub.weight}%)</p>
                                 <span class="text-xs font-bold ${subColor}">${sub.status}</span>
                             </div>
                             <div class="mt-1 flex justify-between items-end">
                                 <p class="text-xl font-bold text-gray-800">${sub.displayScore}</p>
                                 <p class="text-xs text-gray-500">${sub.num} / ${sub.den}</p>
                             </div>
                         </div>
                     `;
                 });
                 
            } else {
                c7SubscoresDiv.classList.add('hidden');
            }
        }
        
        /**
         * Alterna entre as views do Dashboard.
         * @param {string} viewName - O nome da vista a ser exibida.
         */
        function switchView(viewName) {
            // Esconde todas as views
            document.getElementById('view-overview').classList.add('hidden');
            document.getElementById('view-details').classList.add('hidden');
            document.getElementById('view-vinculo').classList.add('hidden'); 
            document.getElementById('view-poeps-monthly-plan').classList.add('hidden');
            document.getElementById('view-poeps-annual-plan').classList.add('hidden');
            document.getElementById('view-poeps-monthly-eval').classList.add('hidden');
            document.getElementById('view-poeps-quarterly-eval').classList.add('hidden');
            document.getElementById('view-poeps-quarterly-eval-current').classList.add('hidden'); 
            // REMOVIDO: document.getElementById('view-municipality-info').classList.add('hidden');
            document.getElementById('view-pse').classList.add('hidden'); 

            
            let viewToShow = viewName;
            let navIdToHighlight = `nav-${viewName}`;
            
            const isCofinanciamentoVinculo = currentIncentiveProgram === 'cofinanciamento' && currentCofinanciamentoView === 'vinculo';
            const isPOEPS = currentIncentiveProgram === 'poeps';
            const isPSE = currentIncentiveProgram === 'pse';

            // Mapeamento de Views
            const viewMapping = {
                'overview': isCofinanciamentoVinculo ? 'view-vinculo' : 'view-overview',
                'details': 'view-details', 
                'pse': 'view-pse', 
                'poeps-monthly-plan': 'view-poeps-monthly-plan',
                'poeps-quarterly-eval-current': 'view-poeps-quarterly-eval-current', 
                'poeps-annual-plan': 'view-poeps-annual-plan',
                'poeps-monthly-eval': 'view-poeps-monthly-eval',
                'poeps-quarterly-eval': 'view-poeps-quarterly-eval',
                // REMOVIDO: 'municipality-info': 'view-municipality-info',
            };
            
            // Define o ID final da view e o ID de navega√ß√£o a ser ativado
            if (isPOEPS || isPSE) {
                 viewToShow = viewName;
                 navIdToHighlight = `nav-${viewName}`;
            } else if (isCofinanciamentoVinculo) {
                 // Se estiver em V√≠nculo e tentar ir para 'details', fica em 'overview' (V√≠nculo)
                 if (viewName === 'details') viewToShow = 'overview';
                 navIdToHighlight = 'nav-overview';
            }
            
            const finalViewId = viewMapping[viewToShow] || 'view-overview'; // Fallback seguro
            
            // 1. Atualiza a visibilidade da navega√ß√£o
            updateSidebarNav();

            // 2. Exibe a view correta
            const selectedView = document.getElementById(finalViewId);
            if (selectedView) {
                selectedView.classList.remove('hidden');
                selectedView.classList.add('fade-in');
            }


            // 3. Destaca o bot√£o de navega√ß√£o correto
            document.querySelectorAll('aside nav a.nav-item').forEach(item => {
                item.classList.remove('bg-blue-50', 'text-blue-700');
                item.classList.add('text-gray-600', 'hover:bg-gray-50');
            });
            
            const activeNav = document.getElementById(navIdToHighlight);
            if (activeNav) {
                activeNav.classList.add('bg-blue-50', 'text-blue-700');
                activeNav.classList.remove('text-gray-600', 'hover:bg-gray-50');
            }
            
            const data = getActiveData();

            if (finalViewId === 'view-details') {
                renderIndicatorNav(data); // Chama a fun√ß√£o para renderizar o nav horizontal
                loadIndicatorDetail(0); 
                document.getElementById('detail-panel').classList.remove('hidden'); // Garante que o painel de detalhes est√° vis√≠vel
                document.getElementById('detail-team-name').innerText = data.teamName;
            } else if (finalViewId === 'view-pse') { // NOVO CHAMADA
                 renderPSETable(data); // Chama o render da tabela PSE
            } else if (finalViewId === 'view-poeps-quarterly-eval-current') {
                 renderPoepsQuarterlyEvaluation(data);
            } else if (finalViewId === 'view-poeps-monthly-plan') {
                 renderPoepsMonthlyPlan(data);
            } else if (finalViewId === 'view-poeps-annual-plan') {
                 renderPoepsAnnualPlan(data);
            } else if (finalViewId === 'view-vinculo') {
                 renderVinculoAcompanhamento(data);
            } else if (finalViewId === 'view-poeps-monthly-eval') {
                 renderPoepsMonthlyEvaluation(data);
            }
            
            renderDashboard(); // Sempre chama para atualizar gr√°ficos e cabe√ßalho, se aplic√°vel
        }
        
        // --- DASHBOARD SIDEBAR CHANGE LOGIC (Mantido) ---
        function loadTeamType(teamType) {
            currentTeamType = teamType;
            const munData = municipalityData[currentMunicipalityId];
            if (!munData.teams[teamType] || Object.keys(munData.teams[teamType]).length === 0) {
                currentTeamId = '';
                populateTeamSelector({});
            } else {
                currentTeamId = Object.keys(munData.teams[teamType])[0];
                populateTeamSelector(munData.teams[teamType]);
            }
            currentIndicatorIndex = 0;
            
            const programSelectDash = document.getElementById('incentive-program-select');
            const cofinanciamentoSelectDash = document.getElementById('cofinanciamento-view-select');

            const isRestricted = currentTeamType === 'esb' || currentTeamType === 'emulti';
            
            if (isRestricted) {
                // Restri√ß√£o: Somente Cofinanciamento e Indicadores de Qualidade
                programSelectDash.innerHTML = '<option value="cofinanciamento">Cofinanciamento Federal</option>';
                programSelectDash.value = 'cofinanciamento';
                currentIncentiveProgram = 'cofinanciamento';
                
                cofinanciamentoSelectDash.innerHTML = '<option value="indicadores">Indicadores de Qualidade</option>';
                cofinanciamentoSelectDash.value = 'indicadores';
                currentCofinanciamentoView = 'indicadores';
                
                document.getElementById('cofinanciamento-sub-selector').classList.remove('hidden');

            } else {
                // Restaura as op√ß√µes padr√£o para eSF/eAP
                programSelectDash.innerHTML = `
                     <option value="cofinanciamento">Cofinanciamento Federal</option>
                     <option value="poeps">POEPS</option>
                     <option value="pse">PSE</option>
                `;
                programSelectDash.value = 'cofinanciamento';
                currentIncentiveProgram = 'cofinanciamento';
                
                cofinanciamentoSelectDash.innerHTML = `
                     <option value="indicadores">Indicadores de Qualidade</option>
                     <option value="vinculo">V√≠nculo e Acompanhamento</option>
                `;
                cofinanciamentoSelectDash.value = 'indicadores';
                currentCofinanciamentoView = 'indicadores';
                
                document.getElementById('cofinanciamento-sub-selector').classList.remove('hidden');
            }
            
            // Redireciona para a view correta
            let newView = 'overview';
            if (currentIncentiveProgram === 'poeps') newView = 'poeps-monthly-eval';
            if (currentIncentiveProgram === 'pse') newView = 'pse'; // NOVO: Redireciona para PSE
            
            switchView(newView);
        }
        
        function loadCofinanciamentoView(viewId) {
            const isRestricted = currentTeamType === 'esb' || currentTeamType === 'emulti';

            // Se for eSB/eMulti, ignora qualquer mudan√ßa que n√£o seja 'indicadores'
            if (isRestricted && viewId !== 'indicadores') {
                document.getElementById('cofinanciamento-view-select').value = 'indicadores';
                viewId = 'indicadores';
            }
            
            currentCofinanciamentoView = viewId;
            // Redireciona a visualiza√ß√£o principal
            let newView = 'overview'; // SwitchView se encarrega de mapear 'overview' para 'vinculo' se necess√°rio
            switchView(newView); 
        }

        function loadIncentiveProgram(programId) {
            const isRestricted = currentTeamType === 'esb' || currentTeamType === 'emulti';

            // Se for eSB/eMulti, ignora qualquer mudan√ßa que n√£o seja 'cofinanciamento'
            if (isRestricted && programId !== 'cofinanciamento') {
                 document.getElementById('incentive-program-select').value = 'cofinanciamento';
                 programId = 'cofinanciamento';
            }
            
            currentIncentiveProgram = programId;
            
            const subSelectorDiv = document.getElementById('cofinanciamento-sub-selector');

            if (programId === 'cofinanciamento') {
                subSelectorDiv.classList.remove('hidden');
                
                const cofinanciamentoSelect = document.getElementById('cofinanciamento-view-select');
                
                if (isRestricted) {
                    // Restringe para eSB/eMulti
                    cofinanciamentoSelect.innerHTML = '<option value="indicadores">Indicadores de Qualidade</option>';
                    currentCofinanciamentoView = 'indicadores';
                    cofinanciamentoSelect.value = 'indicadores';
                } else if (cofinanciamentoSelect.options.length < 2) {
                     // Restaura as op√ß√µes se n√£o for eSB/eMulti
                     cofinanciamentoSelect.innerHTML = `
                        <option value="indicadores">Indicadores de Qualidade</option>
                        <option value="vinculo">V√≠nculo e Acompanhamento</option>
                    `;
                    currentCofinanciamentoView = 'indicadores';
                    cofinanciamentoSelect.value = 'indicadores';
                } else {
                    // Mant√©m o estado, se houver
                    cofinanciamentoSelect.value = currentCofinanciamentoView;
                }
                
            } else {
                subSelectorDiv.classList.add('hidden');
                currentCofinanciamentoView = 'indicadores'; 
            }
            
            // Redireciona para a view padr√£o do programa
            let newView = programId === 'cofinanciamento' ? 'overview' : // SwitchView far√° o mapeamento se for v√≠nculo
                          programId === 'poeps' ? 'poeps-monthly-eval' : 'pse'; // NOVO: Redireciona para PSE
            switchView(newView);
        }


        function loadTeam(teamId) {
            currentTeamId = teamId;
            currentIndicatorIndex = 0;
            // ESSENCIAL: Redesenha o dashboard sem mudar a view
            renderDashboard(); 
            
            // For√ßa a recarregar o conte√∫do espec√≠fico se estiver em V√≠nculo ou Detalhes/POEPS/Info Munic√≠pio
            const activeViewId = document.querySelector('main > div:not(.hidden)').id;

            if (activeViewId === 'view-details') {
                 renderIndicatorNav(getActiveData()); // Adicionado para garantir que o nav seja redesenhado
                 loadIndicatorDetail(0);
            } else if (activeViewId === 'view-pse') { // <-- CHAMADA AQUI
                 renderPSETable(getActiveData());
            } else if (activeViewId === 'view-poeps-quarterly-eval-current') {
                 renderPoepsQuarterlyEvaluation(getActiveData());
            } else if (activeViewId === 'view-poeps-monthly-plan') {
                 renderPoepsMonthlyPlan(getActiveData());
            } else if (activeViewId === 'view-poeps-annual-plan') {
                 renderPoepsAnnualPlan(getActiveData());
            } else if (activeViewId === 'view-vinculo') {
                 renderVinculoAcompanhamento(getActiveData());
            } else if (activeViewId === 'view-poeps-monthly-eval') {
                 renderPoepsMonthlyEvaluation(getActiveData());
            }
        }

        function populateTeamSelector(teams) {
            const select = document.getElementById('team-select');
            select.innerHTML = '';
            
            Object.keys(teams).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.innerText = teams[id].teamName;
                select.appendChild(option);
            });
            select.value = currentTeamId;
        }


        // --- DASHBOARD RENDERING ---
        function renderDashboard() {
            const data = getActiveData();
            if (!data) return;

            updateHeader(data); 
            renderOverview(data); 
        }

        /**
         * Prepara os dados dos indicadores ativos para os gr√°ficos.
         */
        function getChartData(indicators) {
            const chartData = {
                labels: [],
                results: [],
                metas: [],
                colors: [],
                normalizedResults: [], // 0-100% para Radar
                displayResults: []
            };

            indicators.forEach(perf => {
                const key = perf.cod;
                const meta = ESF_INDICATOR_METADATA[key];
                const statusColor = STATUS_COLORS[perf.status];
                
                // 1. Normaliza√ß√£o para o Gr√°fico Radar (0-100%)
                let normalizedScore;
                
                if (key === 'C1') {
                    // C1 (Mais Acesso): Proximidade de 60%. (Longe de 60 √© ruim)
                    // Max distance from 60 is 60 (when result is 0 or 120).
                    normalizedScore = Math.min(100 - (Math.abs(perf.result - 60) / 60) * 100, 100);
                } else if (key === 'B3') {
                    // B3 (Taxa de Exodontia): Band Score [8%, 14%). √ìtimo [8, 10).
                    // Vamos normalizar para 100% no 9% (o centro do √≥timo)
                    const optimalCenter = 9; 
                    const maxDistance = 9; 

                    const distance = Math.abs(perf.result - optimalCenter);
                    
                    if (perf.result >= 14 || perf.result <= 0) {
                         normalizedScore = 0;
                    } else if (perf.result > 0 && perf.result < 8) {
                        normalizedScore = (perf.result / 8) * 80; 
                    } else {
                        normalizedScore = Math.max(0, 100 - (distance / (14 - optimalCenter)) * 100);
                    }
                    normalizedScore = Math.min(normalizedScore, 100);

                } else if (key === 'B5') {
                    // B5 (Procedimentos Preventivos): Band Score [40%, 85%]. √ìtimo [80%, 85%].
                    const optimalCenter = 82.5; 
                    const maxDistance = 42.5; 

                    if (perf.result < 40 || perf.result > 85) {
                         normalizedScore = 0; 
                    } else if (perf.result >= 80 && perf.result <= 85) {
                         normalizedScore = 100 - (Math.abs(perf.result - optimalCenter) / 5) * 20; 
                    } else {
                         normalizedScore = 100 - ((optimalCenter - perf.result) / maxDistance) * 100; 
                    }
                    normalizedScore = Math.min(normalizedScore, 100);

                } else if (key === 'M1') {
                    // M1 (M√©dia Atendimentos/Pessoa): FATOR. Meta > 3.0.
                    normalizedScore = Math.min((perf.result / meta.meta) * 100, 100);
                } else if (key === 'M2') {
                    // M2 (A√ß√µes Interprofissionais): PORCENTAGEM. Meta > 5%.
                    normalizedScore = Math.min((perf.result / perf.meta) * 100, 100);
                } else if (key.startsWith('B')) {
                    // B1, B2, B4, B6 (Mais √© melhor, meta B1=5, B2=75, B4=1, B6=8)
                    normalizedScore = Math.min((perf.result / meta.meta) * 100, 100);
                } else {
                    // Padr√£o C2-C7
                    normalizedScore = Math.min((perf.result / perf.meta) * 100, 100);
                }


                chartData.labels.push(key);
                chartData.results.push(perf.result);
                chartData.metas.push(perf.meta);
                chartData.colors.push(statusColor.hex);
                chartData.normalizedResults.push(Math.round(normalizedScore));
                chartData.displayResults.push(perf.displayResult);
            });

            return chartData;
        }

        // MUDAN√áA AQUI: REMO√á√ÉO DA INFORMA√á√ÉO DA META DO CARD DE ESTAT√çSTICAS
        function renderOverview(data) {
            const isIndicatorViewActive = currentIncentiveProgram === 'cofinanciamento' && currentCofinanciamentoView === 'indicadores';
            if (!isIndicatorViewActive) return;

            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = ''; 
            
            // --- ATUALIZA√á√ÉO DA MENSAGEM DE INTRODU√á√ÉO ---
            const introText = document.getElementById('overview-intro-text');
            if (currentTeamType === 'esb') {
                introText.innerHTML = `
                    Esta vis√£o consolida os indicadores de Sa√∫de Bucal (B1-B6) da equipe **${data.teamName}**. 
                    Utilize o gr√°fico de Barras para comparar o desempenho com a meta (B3 e B5 s√£o pontua√ß√µes por faixa) 
                    e o gr√°fico Radar para identificar o equil√≠brio das m√©tricas de sa√∫de bucal.
                `;
            } else if (currentTeamType === 'emulti') {
                 // DESCRI√á√ÉO ALTERADA CONFORME SOLICITADO PELO USU√ÅRIO
                 introText.innerHTML = `
                    Esta vis√£o consolida os indicadores da Equipe Multiprofissional. As m√©tricas M1 e M2 avaliam o acesso e a integra√ß√£o das a√ß√µes.
                `;
            } else if (currentTeamType === 'esf_eap') {
                 introText.innerHTML = `
                    Esta vis√£o consolida os indicadores de desempenho da equipe. Utilize o gr√°fico Radar para identificar o equil√≠brio entre as linhas de cuidado e o gr√°fico de Barras para comparar o desempenho com a meta.
                `;
            }

            // --- PREPARA√á√ÉO DE DADOS PARA GR√ÅFICOS E CARDS ---
            const chartData = getChartData(data.indicators);
            
            data.indicators.forEach(perf => {
                const key = perf.cod;
                const meta = ESF_INDICATOR_METADATA[key];
                const statusColor = STATUS_COLORS[perf.status];
                
                // Mapeamento de Suffix para exibi√ß√£o da Meta
                let metaText = '';
                if (key === 'B1') {
                     metaText = 'Meta √ìtimo: > 5%';
                } else if (key === 'B2') {
                     metaText = 'Meta √ìtimo: > 75%';
                } else if (key === 'B3') {
                     metaText = 'Faixa Ideal: 8% a < 14%';
                } else if (key === 'B4') {
                     metaText = 'Meta √ìtimo: > 1%';
                } else if (key === 'B5') {
                     metaText = 'Faixa √ìtima: 80% a 85%';
                } else if (key === 'B6') {
                     metaText = 'Meta √ìtimo: > 8%';
                } else if (key === 'M1') {
                     metaText = 'Meta: > 3.0'; // ATUALIZADO
                } else if (key === 'M2') {
                     metaText = 'Meta: > 5%'; // ATUALIZADO
                } else if (key === 'C7') {
                     metaText = 'Meta: > 75 pts';
                } else {
                     metaText = `Meta M√≠nima: ${meta.meta}%`;
                }


                const cardHtml = `
                    <div class="bg-white p-5 rounded-xl shadow-md border ${statusColor.bg} border-gray-200 card-hover">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${statusColor.bg} ${statusColor.text}">${key}</span>
                            <span class="text-xs font-semibold ${statusColor.text}">${perf.status}</span>
                        </div>
                        <h4 class="text-base font-semibold text-gray-900 truncate">${perf.title}</h4>
                        <p class="text-3xl font-extrabold mt-1">${perf.displayResult}</p>
                        <!-- Nova linha de meta para B3 e B5/B6 -->
                        <p class="text-xs text-gray-500 mt-1">${metaText}</p>
                    </div>
                `;
                statsGrid.innerHTML += cardHtml;
            });
            
            // Chamada dos gr√°ficos
            initCharts(chartData, currentTeamType);
        }
        
        
        // --- FUN√á√ïES CHART.JS PARA VISUALIZA√á√ÉO DOS INDICADORES ---

        /**
         * Destr√≥i inst√¢ncias antigas de gr√°ficos e chama a inicializa√ß√£o dos novos.
         * @param {object} chartData - Dados formatados (labels, results, metas, etc.).
         * @param {string} teamType - Tipo da equipe (usado para ajustar t√≠tulos e escalas).
         */
        function initCharts(chartData, teamType) {
            // Destr√≥i inst√¢ncias anteriores para evitar duplica√ß√£o
            if (chartInstances.barChart) chartInstances.barChart.destroy();
            if (chartInstances.radarChart) chartInstances.radarChart.destroy();

            // Os gr√°ficos s√£o vis√≠veis e populados, mesmo para eSB/eMulti (apenas 2 ou 6 indicadores)
            initBarChart(chartData, teamType);
            initRadarChart(chartData, teamType);
        }

        /**
         * Inicializa o Gr√°fico de Colunas (Barra) para Resultados vs. Meta.
         */
        function initBarChart(chartData, teamType) {
            const ctx = document.getElementById('barChart').getContext('2d');
            const isEmulti = teamType === 'emulti';
            
            // Base para as cores da barra
            const barColors = chartData.colors;

            // Configura√ß√£o da escala Y
            let yMax = 100;
            let yStepSize = 10;
            let yTickCallback = (value) => value.toFixed(0) + '%';
            
            if (isEmulti) {
                 // Para eMulti, M1 √© um fator, M2 √© porcentagem. A escala precisa ser adapt√°vel.
                 // CORRE√á√ÉO: Para o Bar Chart, vamos manter a escala em % e adaptar o M1 para ser um % da meta de 3.0 (max 100%)
                 
                 const adaptedResults = chartData.results.map((result, index) => {
                     const key = chartData.labels[index];
                     if (key === 'M1') {
                         return Math.min((result / ESF_INDICATOR_METADATA.M1.meta) * 100, 100);
                     } else {
                         return result;
                     }
                 });
                 
                 const adaptedMetas = chartData.metas.map((metaVal, index) => {
                     const key = chartData.labels[index];
                     if (key === 'M1') {
                          return 100; // A meta de M1 (3.0) ser√° representada por 100% nesta escala
                     } else {
                         return metaVal;
                     }
                 });
                 
                 // Ajusta os ticks para n√£o mostrar '%' no M1 (Bar Chart)
                 yTickCallback = (value) => value.toFixed(0) + '%';
                 yMax = 100;
                 yStepSize = 10;
                 
                 chartData.results = adaptedResults;
                 chartData.metas = adaptedMetas;
            }


            chartInstances.barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Resultado Atual',
                            data: chartData.results,
                            backgroundColor: barColors,
                            borderColor: barColors.map(c => c.substring(0, 7)),
                            borderWidth: 1,
                            order: 1,
                            datalabels: {
                                color: '#333333',
                                anchor: 'end',
                                align: 'top',
                                formatter: (value, context) => {
                                    // NO BAR CHART, MOSTRAR O VALOR ORIGINAL, mas na escala de 0-100%
                                    return chartData.displayResults[context.dataIndex]; // Usa o resultado formatado
                                }
                            }
                        },
                        {
                            label: 'Meta M√≠nima',
                            data: chartData.metas,
                            type: 'line',
                            borderColor: STATUS_COLORS.Regular.metaColor, // Linha de meta sempre em vermelho escuro
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: STATUS_COLORS.Regular.metaColor,
                            tension: 0.1,
                            order: 0,
                            datalabels: {
                                display: false
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yMax,
                            title: { display: true, text: '% de Cobertura/Ades√£o' },
                            ticks: {
                                stepSize: yStepSize,
                                callback: yTickCallback
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    layout: { padding: { top: 20 } }
                }
            });
        }

        /**
         * Inicializa o Gr√°fico Radar para Equil√≠brio da Equipe (Normalized 0-100%).
         */
        function initRadarChart(chartData, teamType) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const dataColors = chartData.colors;

            // Labels simplificadas para o radar (apenas o c√≥digo)
            const radarLabels = chartData.labels.map(l => {
                const meta = ESF_INDICATOR_METADATA[l];
                let suffix = '%';
                if (l === 'M1') suffix = '';
                else if (l === 'C7') suffix = ' pts';

                return `${l}\n(${meta.meta}${suffix})`;
            });

            chartInstances.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: radarLabels,
                    datasets: [
                        {
                            label: 'Desempenho (Max 100%)',
                            data: chartData.normalizedResults, // Usa o resultado normalizado (0-100)
                            backgroundColor: 'rgba(59, 130, 246, 0.2)', // blue-500
                            borderColor: STATUS_COLORS.√ìtimo.hex, 
                            pointBackgroundColor: chartData.colors, 
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: chartData.colors,
                            borderWidth: 2,
                            fill: true,
                            datalabels: {
                                color: '#444444',
                                font: { weight: 'bold', size: 10 },
                                formatter: (value) => `${value.toFixed(0)}%`,
                                display: true 
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(107, 114, 128, 0.4)' },
                            grid: { color: 'rgba(107, 114, 128, 0.3)' },
                            pointLabels: {
                                font: { size: 11, weight: 'bold' },
                                color: '#1f2937'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                stepSize: 20,
                                showLabelBackdrop: false,
                                callback: (value) => `${value.toFixed(0)}%`
                            }
                        }
                    }
                }
            });
        }

        
        // --- FUN√á√ïES DE C7 COMPLEX CALCULATION LOGIC (Mantido) ---
        function calculateC7(data) {
            const isNewFormat = data.cervicalDen !== undefined;

            let result_cervical, result_hpv, result_consultation, result_mammo;
            let totalScore = 0;
            let subScores = [];
            
            if (isNewFormat) {
                // Previne divis√£o por zero (fallback para 1 se den for 0 para n√£o quebrar a l√≥gica, embora a pontua√ß√£o deve ser 0)
                const cervDen = data.cervicalDen > 0 ? data.cervicalDen : 1;
                const hpvDen = data.hpvDen > 0 ? data.hpvDen : 1;
                const consultDen = data.consultDen > 0 ? data.consultDen : 1;
                const mammoDen = data.mammoDen > 0 ? data.mammoDen : 1;
                
                // C√°lculo conforme as novas regras: (Num / Den) * Peso
                // O resultado do c√°lculo √© a PONTUA√á√ÉO (m√°x 20, 30, 30, 20)
                result_cervical = (data.cervicalNum / cervDen) * 20; 
                result_hpv = (data.hpvNum / hpvDen) * 30; 
                result_consultation = (data.consultNum / consultDen) * 30; 
                result_mammo = (data.mammoNum / mammoDen) * 20; 

                // Zera o resultado se o denominador for 0 (para pontua√ß√£o correta)
                if (data.cervicalDen === 0) result_cervical = 0;
                if (data.hpvDen === 0) result_hpv = 0;
                if (data.consultDen === 0) result_consultation = 0;
                if (data.mammoDen === 0) result_mammo = 0;

                totalScore = result_cervical + result_hpv + result_consultation + result_mammo;
                
                // C7 classifica a pontua√ß√£o total (0-100). Para os sub-scores, classificamos o percentual de cumprimento.
                
                subScores = [
                    { name: "Citopatol√≥gico (25-64)", num: data.cervicalNum, den: cervDen, weight: 20, score: result_cervical, displayScore: result_cervical.toFixed(2).replace('.', ',') + ' pts', status: classifyScore(result_cervical * 5, ESF_INDICATOR_METADATA.C7.criteria, 'C7') }, // Multiplica por 5 para ter o %
                    { name: "Vacina HPV (9-14)", num: data.hpvNum, den: hpvDen, weight: 30, score: result_hpv, displayScore: result_hpv.toFixed(2).replace('.', ',') + ' pts', status: classifyScore(result_hpv / 0.30 * 100, ESF_INDICATOR_METADATA.C7.criteria, 'C7') }, // Divide pelo peso (30%) e multiplica por 100
                    { name: "Consulta Mulher (14-69)", num: data.consultNum, den: consultDen, weight: 30, score: result_consultation, displayScore: result_consultation.toFixed(2).replace('.', ',') + ' pts', status: classifyScore(result_consultation / 0.30 * 100, ESF_INDICATOR_METADATA.C7.criteria, 'C7') },
                    { name: "Mamografia (50-69)", num: data.mammoNum, den: mammoDen, weight: 20, score: result_mammo, displayScore: result_mammo.toFixed(2).replace('.', ',') + ' pts', status: classifyScore(result_mammo * 5, ESF_INDICATOR_METADATA.C7.criteria, 'C7') }
                ];
                
                // Recalculando o status dos sub-scores usando o percentual de cumprimento. O crit√©rio usado √© o padr√£o (>75% √≥timo, etc.)
                subScores[0].status = classifyScore((data.cervicalNum / cervDen) * 100, ESF_INDICATOR_METADATA.C7.criteria, 'SUB-C7');
                subScores[1].status = classifyScore((data.hpvNum / hpvDen) * 100, ESF_INDICATOR_METADATA.C7.criteria, 'SUB-C7');
                subScores[2].status = classifyScore((data.consultNum / consultDen) * 100, ESF_INDICATOR_METADATA.C7.criteria, 'SUB-C7');
                subScores[3].status = classifyScore((data.mammoNum / mammoDen) * 100, ESF_INDICATOR_METADATA.C7.criteria, 'SUB-C7');

            } // else branch not needed as all current teams use the new format.

            // The main C7 status classifies the totalScore out of 100.
            const status = classifyScore(totalScore, ESF_INDICATOR_METADATA.C7.criteria, 'C7');

            return {
                result: totalScore, 
                num: totalScore,
                den: 100, 
                status: status,
                subScores: subScores,
                c7Data: data
            };
        }

        // --- CLASSIFICATION HELPER (ATUALIZADO COM OS NOVOS CRIT√âRIOS DE EMULTI) ---
        function classifyScore(result, criteria, cod) {
            let percentageValue = result;

            // L√≥gica C1: Mais Acesso (eSF/eAP) - Desvio do Centro 60%
            if (cod === 'C1') { 
                if (percentageValue > 50 && percentageValue <= 70) return '√ìtimo';
                if (percentageValue > 30 && percentageValue <= 50) return 'Bom';
                if (percentageValue > 10 && percentageValue <= 30) return 'Suficiente';
                return 'Regular'; // Inclui resultados ‚â§ 10% ou > 70% (desequil√≠brio)
            }
            
            // =========================================================
            // L√ìGICA DE CLASSIFICA√á√ÉO PARA INDICADORES ESB (B1-B6)
            // =========================================================

            // L√≥gica B1: Primeira Consulta Programada (Meta > 5%)
            if (cod === 'B1') { 
                if (percentageValue > 5) return '√ìtimo';
                if (percentageValue > 3 && percentageValue <= 5) return 'Bom';
                if (percentageValue > 1 && percentageValue <= 3) return 'Suficiente';
                return 'Regular'; // ‚â§ 1%
            }

            // L√≥gica B2: Tratamento Conclu√≠do (Meta > 75%)
            if (cod === 'B2') { 
                if (percentageValue > 75 && percentageValue <= 100) return '√ìtimo';
                if (percentageValue > 50 && percentageValue <= 75) return 'Bom';
                if (percentageValue > 25 && percentageValue <= 50) return 'Suficiente';
                return 'Regular'; // ‚â§ 25%
            }

            // L√≥gica B3: Taxa de Exodontia (Band Score: [8%, 14%))
            // √ìtimo: [8, 10), Bom: [10, 12), Suficiente: [12, 14)
            if (cod === 'B3') { 
                if (percentageValue < 8) return 'Regular'; // < 8%
                if (percentageValue >= 14) return 'Regular'; // >= 14%
                
                // Dentro da faixa ideal [8, 14)
                if (percentageValue >= 12 && percentageValue < 14) return 'Suficiente';
                if (percentageValue >= 10 && percentageValue < 12) return 'Bom';
                if (percentageValue >= 8 && percentageValue < 10) return '√ìtimo'; 
                
                return 'N/A'; // Deve ser coberto pela l√≥gica acima, mas mantido para seguran√ßa.
            }

            // L√≥gica B4: Escova√ß√£o Supervisionada (Meta > 1%)
            if (cod === 'B4') { 
                if (percentageValue > 1) return '√ìtimo';
                if (percentageValue > 0.5 && percentageValue <= 1) return 'Bom';
                if (percentageValue > 0.25 && percentageValue <= 0.5) return 'Suficiente';
                return 'Regular'; // ‚â§ 0.25%
            }

            // L√≥gica B5: Procedimentos Preventivos (Band Score: [40%, 85%])
            // √ìtimo: [80%, 85%]
            if (cod === 'B5') { 
                if (percentageValue < 40) return 'Regular'; // < 40%
                if (percentageValue > 85) return 'Regular'; // > 85%
                
                // Dentro da faixa ideal [40%, 85%]
                if (percentageValue >= 80 && percentageValue <= 85) return '√ìtimo';
                if (percentageValue >= 60 && percentageValue < 80) return 'Bom';
                if (percentageValue >= 40 && percentageValue < 60) return 'Suficiente';
                
                return 'N/A'; // Deve ser coberto pela l√≥gica acima
            }

            // L√≥gica B6: Tratamento Restaurador Atraum√°tico (ART) (Meta > 8%)
            if (cod === 'B6') { 
                if (percentageValue > 8) return '√ìtimo';
                if (percentageValue > 6 && percentageValue <= 8) return 'Bom';
                if (percentageValue > 3 && percentageValue <= 6) return 'Suficiente';
                return 'Regular'; // ‚â§ 3%
            }
            
            // =========================================================
            // FIM L√ìGICA ESB
            // =========================================================
            
            // =========================================================
            // L√ìGICA DE CLASSIFICA√á√ÉO PARA INDICADORES EMULTI (M1-M2) - ATUALIZADA
            // =========================================================

            // L√≥gica M1: M√©dia de Atendimentos por Pessoa (eMulti) - Meta > 3.0
            if (cod === 'M1') {
                if (percentageValue > 3) return '√ìtimo'; 
                if (percentageValue > 2 && percentageValue <= 3) return 'Bom';
                if (percentageValue > 1 && percentageValue <= 2) return 'Suficiente';
                return 'Regular'; // ‚â§1
            }
            
             // L√≥gica M2: A√ß√µes Interprofissionais (eMulti) - Meta > 5%
            if (cod === 'M2') {
                if (percentageValue > 5) return '√ìtimo'; 
                if (percentageValue > 2.5 && percentageValue <= 5) return 'Bom';
                if (percentageValue > 1 && percentageValue <= 2.5) return 'Suficiente';
                return 'Regular'; // ‚â§1%
            }
            
            // =========================================================
            // FIM L√ìGICA EMULTI
            // =========================================================


            // L√≥gica Padr√£o 75% (Aplica-se a C2-C6 e SUB-C7)
            if (cod === 'C7') {
                 // C7 √© a pontua√ß√£o (0-100)
                if (percentageValue >= 75) return '√ìtimo';
                if (percentageValue >= 50) return 'Bom';
                if (percentageValue >= 25) return 'Suficiente';
                return 'Regular';
            }
            
            if (cod.startsWith('C') || cod.startsWith('SUB-C7')) {
                // Indicadores C2-C6 e sub-scores (que s√£o percentuais de cobertura)
                if (percentageValue >= 75) return '√ìtimo';
                if (percentageValue >= 50) return 'Bom';
                if (percentageValue >= 25) return 'Suficiente';
                return 'Regular';
            }
            
            // L√≥gica Global Score
            if (cod === 'GLOBAL') {
                 if (percentageValue >= 75) return '√ìtimo';
                if (percentageValue >= 50) return 'Bom';
                if (percentageValue >= 25) return 'Suficiente';
                return 'Regular';
            }

            return 'N/A';
        }

        /**
         * Calculates the result for C1-C6, B1-B6, M1-M2 as a factor or percentage.
         * @param {string} cod - C√≥digo do indicador (e.g., 'C1', 'B3').
         * @param {number} num - Numerador.
         * @param {number} den - Denominador.
         * @returns {number} O resultado do c√°lculo (em % ou fator).
         */
        function calculateIndicatorResult(cod, num, den) {
             if (den === 0) return 0;
             const rawResult = (num / den);
             
             // C1: Porcentagem. C2-C6: Mock com fator de 100 a mais (ajustado no mockData)
             if (cod.startsWith('C') && cod.length === 2) {
                 if (cod === 'C1') {
                     return rawResult * 100;
                 }
                 // C2-C6 (usando mock data que j√° tem um fator de 100 inserido)
                 let result = rawResult * 100;
                 if (['C2', 'C3', 'C4', 'C5', 'C6'].includes(cod)) {
                      result = result / 100; 
                 }
                 return result;
             }
             
             // M1: Fator bruto (e.g. 1.25)
             if (cod === 'M1') {
                return rawResult; 
             }
             
             // M2 e B1-B6: Porcentagem
             if (cod.startsWith('M') || cod.startsWith('B')) {
                 return rawResult * 100; 
             }

             return rawResult; 
        }
        
        // Helper para criar o objeto final de indicador
        function createIndicator(cod, data, metaData) {
            const meta = metaData[cod];
            
            let actionTip;
            const actionBase = meta.actionTipBase;
            const result = data.result;
            const status = data.status;

            // Se o actionTipBase for um bloco HTML, mantemos ele
            if (cod === 'C2' && actionBase.includes('<div')) {
                 actionTip = actionBase;
            } else if (status === '√ìtimo') {
                 actionTip = `Excelente desempenho! A recomenda√ß√£o √© manter os processos e focar na manuten√ß√£o da qualidade do registro. (${actionBase})`;
            } else if (status === 'Bom') {
                 actionTip = `Bom resultado. Para atingir o √ìtimo, foque em ${meta.numDesc} nas pr√≥ximas semanas. A√ß√£o detalhada: ${actionBase}`;
            } else if (status === 'Suficiente') {
                 actionTip = `Alerta Amarelo. H√° fragilidade no processo de ${meta.title}. Recomenda-se uma interven√ß√£o imediata e foco no ${meta.numDesc}. A√ß√£o detalhada: ${actionBase}`;
            } else {
                 actionTip = `CR√çTICO! √â necess√°rio um Plano de A√ß√£o Imediato. Seu ${meta.numDesc} est√° muito abaixo. A√ß√£o priorit√°ria: ${actionBase}`;
            }
            
            if (cod === 'C7') {
                 actionTip = `A pontua√ß√£o total de ${result.toFixed(2).replace('.', ',')} pontos √© uma m√©dia ponderada dos sub-indicadores de preven√ß√£o. A√ß√£o priorit√°ria: ${actionBase}`;
            }
            
            // Formata√ß√£o do Resultado para Display
            let displaySuffix = '%';
            let resultForDisplay = result;
            
            if (cod === 'C7') {
                 displaySuffix = ' pts';
                 resultForDisplay = result.toFixed(2);
            } else if (cod === 'M1') {
                 displaySuffix = ''; 
                 resultForDisplay = result.toFixed(2);
            } else {
                 // C1, C2-C6, B1-B6, M2 (todos em %)
                 resultForDisplay = result.toFixed(2);
                 displaySuffix = '%';
            }


            return {
                cod: cod,
                title: meta.title,
                result: result,
                displayResult: resultForDisplay.replace('.', ',') + displaySuffix,
                meta: meta.meta,
                status: status,
                num: data.num,
                den: data.den,
                numDesc: meta.numDesc,
                denDesc: meta.denDesc,
                concept: meta.concept,
                criteria: meta.criteria,
                action: actionTip,
                registro: meta.registro, // NOVO: Campo de registro
                color: STATUS_COLORS[status]?.hex,
                subScores: data.subScores || null, 
                c7Data: data.c7Data || null
            };
        }

        /**
         * Retorna os indicadores processados com base no tipo de equipe.
         * @param {string} munId - ID do munic√≠pio.
         * @param {string} teamType - Tipo de equipe (esf_eap, esb, emulti).
         * @param {string} teamId - ID da equipe (INE).
         * @param {number} [mockScore] - Pontua√ß√£o mock (usada para cidades que n√£o s√£o Camanducaia).
         * @returns {object} { score, classification, indicators }
         */
        function getIndicatorDataByTeamType(munId, teamType, teamId, mockScore) {
            let indicators = [];
            let score = 0;
            let classification = 'N/A';
            
            if (teamType === 'esf_eap') {
                if (munId === 'camanducaia') {
                    // Carrega dados num√©ricos reais mockados para Camanducaia
                    const numData = CAMANDUCAIA_ESF_NUMERICAL_DATA[teamId];
                    if (numData) {
                         indicators = getEsfIndicatorsData(teamId);
                         score = numData.score;
                         classification = numData.classification;
                    }
                } else {
                    // Mock gen√©rico para outras cidades eSF/eAP
                    // Cria dados gen√©ricos com base no mockScore (que simula a m√©dia)
                    // (Mock simples mantido para munic√≠pios gen√©ricos)
                     const mockC1Result = 50 + (mockScore * 0.2 - 15); // Result C1 between 10-90
                     const mockStandardResult = mockScore * 0.8;
                    
                    indicators = [
                        createIndicator("C1", { num: 1, den: 1, result: mockC1Result, status: classifyScore(mockC1Result, ESF_INDICATOR_METADATA.C1.criteria, 'C1') }, ESF_INDICATOR_METADATA),
                        createIndicator("C2", { num: 1, den: 1, result: mockStandardResult, status: classifyScore(mockStandardResult, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, ESF_INDICATOR_METADATA),
                        createIndicator("C3", { num: 1, den: 1, result: mockStandardResult, status: classifyScore(mockStandardResult, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, ESF_INDICATOR_METADATA),
                        createIndicator("C4", { num: 1, den: 1, result: mockStandardResult, status: classifyScore(mockStandardResult, ESF_INDICATOR_METADATA.C4.criteria, 'C4') }, ESF_INDICATOR_METADATA),
                        createIndicator("C5", { num: 1, den: 1, result: mockStandardResult, status: classifyScore(mockStandardResult, ESF_INDICATOR_METADATA.C5.criteria, 'C5') }, ESF_INDICATOR_METADATA),
                        createIndicator("C6", { num: 1, den: 1, result: mockStandardResult, status: classifyScore(mockStandardResult, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, ESF_INDICATOR_METADATA),
                        // C7 mockado com 80 pontos, 100 denominador (80% de pontua√ß√£o)
                        createIndicator("C7", calculateC7({ cervicalNum: 80, cervicalDen: 100, consultNum: 80, consultDen: 100, mammoNum: 80, mammoDen: 100, hpvNum: 80, hpvDen: 100 }), ESF_INDICATOR_METADATA),
                    ].sort((a, b) => a.cod.localeCompare(b.cod));
                    score = mockScore;
                    classification = classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL');
                }
            } else if (teamType === 'esb') {
                // Carrega dados eSB (usando dados internos MOCK_ESB_RESULTS)
                indicators = getEsbIndicatorsData(teamId);
                score = indicators.map(i => i.result).reduce((a, b) => a + b, 0) / indicators.length;
                classification = classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL');
            } else if (teamType === 'emulti') {
                // Carrega dados eMulti
                 indicators = getEmultiIndicatorsData(teamId);
                 
                 // Novo c√°lculo de score e classifica√ß√£o geral da eMulti
                 // Fazemos a m√©dia das classifica√ß√µes (conforme a regra 0-100 para o indicador)
                 // Para o eMulti, n√£o temos uma regra global clara, ent√£o usaremos a m√©dia dos resultados de M1 (normalizado) e M2
                 const m1_norm = Math.min((indicators.find(i => i.cod === 'M1').result / ESF_INDICATOR_METADATA.M1.meta) * 100, 100);
                 const m2_norm = Math.min((indicators.find(i => i.cod === 'M2').result / ESF_INDICATOR_METADATA.M2.meta) * 100, 100);
                 
                 score = (m1_norm + m2_norm) / 2;
                 classification = classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL');
            }

            // Garante que o indicador C7 tenha estrutura completa para o detalhamento se for eSF/eAP
             if (teamType === 'esf_eap' && indicators.length > 0) {
                 const c7Index = indicators.findIndex(i => i.cod === 'C7');
                 if (c7Index !== -1) {
                    const c7Data = indicators[c7Index].c7Data;
                    // Se for Camanducaia, o C7 j√° est√° completo. Se for mock, precisamos garantir subScores para renderDetail
                    if (munId !== 'camanducaia' && !indicators[c7Index].subScores) {
                        indicators[c7Index] = createIndicator("C7", calculateC7(c7Data || { cervicalNum: 80, cervicalDen: 100, consultNum: 80, consultDen: 100, mammoNum: 80, mammoDen: 100, hpvNum: 80, hpvDen: 100 }), ESF_INDICATOR_METADATA);
                    }
                 }
             }

            return { score, classification, indicators };
        }
        
        function getEsfIndicatorsData(teamId) {
            const numericalData = CAMANDUCAIA_ESF_NUMERICAL_DATA[teamId];
            if (!numericalData) return [];
            
            return [
                createIndicator("C1", numericalData["C1"], ESF_INDICATOR_METADATA),
                createIndicator("C2", numericalData["C2"], ESF_INDICATOR_METADATA),
                createIndicator("C3", numericalData["C3"], ESF_INDICATOR_METADATA),
                createIndicator("C4", numericalData["C4"], ESF_INDICATOR_METADATA),
                createIndicator("C5", numericalData["C5"], ESF_INDICATOR_METADATA),
                createIndicator("C6", numericalData["C6"], ESF_INDICATOR_METADATA),
                createIndicator("C7", numericalData["C7"], ESF_INDICATOR_METADATA),
            ].sort((a, b) => a.cod.localeCompare(b.cod));
        }

        function getEsbIndicatorsData(teamId) {
            const mockData = MOCK_ESB_RESULTS[teamId] || MOCK_ESB_RESULTS["esb_cruzeiro"];
            const indicators = [];
            const codes = ["B1", "B2", "B3", "B4", "B5", "B6"];

            codes.forEach(cod => {
                const data = mockData[cod];
                // 1. Recalcula o resultado com a fun√ß√£o unificada, que lida com porcentagem/fator
                const result = calculateIndicatorResult(cod, data.num, data.den); 
                // 2. Classifica o resultado (a fun√ß√£o classifica corretamente B3 (inverso))
                const status = classifyScore(result, ESF_INDICATOR_METADATA[cod].criteria, cod);
                indicators.push(createIndicator(cod, { ...data, result, status }, ESF_INDICATOR_METADATA));
            });

            return indicators.sort((a, b) => a.cod.localeCompare(b.cod));
        }
        
        // NOVO: Fun√ß√£o de gera√ß√£o de Indicadores eMulti
        function getEmultiIndicatorsData(teamId) {
            const mockData = MOCK_EMULTI_RESULTS[teamId] || MOCK_EMULTI_RESULTS["emulti_01"];
            const indicators = [];
            const codes = ["M1", "M2"];

            codes.forEach(cod => {
                const data = mockData[cod];
                const result = calculateIndicatorResult(cod, data.num, data.den); 
                // CLASSIFICA√á√ÉO ATUALIZADA: Usando os novos crit√©rios definidos
                const status = classifyScore(result, ESF_INDICATOR_METADATA[cod].criteria, cod); 
                indicators.push(createIndicator(cod, { ...data, result, status }, ESF_INDICATOR_METADATA));
            });

            return indicators.sort((a, b) => a.cod.localeCompare(b.cod));
        }

        // --- DADOS DO PSE PARA CAMANDUCAIA ---
        const CAMANDUCAIA_PSE_DATA = {
            "esf_centro": [
                {
                    escola: "Centro Municipal de Educa√ß√£o Infantil Milton Salles",
                    acao: "Avaliar resultados das a√ß√µes do 2¬∞ semestre de 2025 - GTIM",
                    responsavel: "Reuni√£o Intersetorial",
                    acoes_pse_correspondentes: "Reuni√£o Intersetorial",
                    registro: "Ficha de Atividade Coletiva e-SUS"
                }
            ],
            "esf_cruzeiro": [
                {
                    escola: "Escola Moreira Brand√£o e CEMEI Luiz Chiaradia",
                    acao: "Avaliar resultados das a√ß√µes do 2¬∞ semestre de 2025 - GTIM",
                    responsavel: "Reuni√£o Intersetorial",
                    acoes_pse_correspondentes: "Reuni√£o Intersetorial",
                    registro: "Ficha de Atividade Coletiva e-SUS"
                }
            ],
            "esf_loteamento": [
                {
                    escola: "PEM Adolfa Maria Orka Plogger",
                    acao: "Avaliar resultados das a√ß√µes do 2¬∞ semestre de 2025 - GTIM",
                    responsavel: "Reuni√£o Intersetorial",
                    acoes_pse_correspondentes: "Reuni√£o Intersetorial",
                    registro: "Ficha de Atividade Coletiva e-SUS"
                }
            ],
            "esf_monte_verde": [
                {
                    escola: "Karlis Kempis e Verner",
                    acao: "Avaliar resultados das a√ß√µes do 2¬∞ semestre de 2025 - GTIM",
                    responsavel: "Reuni√£o Intersetorial",
                    acoes_pse_correspondentes: "Reuni√£o Intersetorial",
                    registro: "Ficha de Atividade Coletiva e-SUS"
                }
            ],
            "esf_ponte_nova": [
                {
                    escola: "Escola Arauc√°ria e Prudente de Moraes",
                    acao: "Avaliar resultados das a√ß√µes do 2¬∞ semestre de 2025 - GTIM",
                    responsavel: "Reuni√£o Intersetorial",
                    acoes_pse_correspondentes: "Reuni√£o Intersetorial",
                    registro: "Ficha de Atividade Coletiva e-SUS"
                }
            ],
            "esf_quedas_verdes": [
                {
                    escola: "Rui Marzag√£o de Carvalho",
                    acao: "Avaliar resultados das a√ß√µes do 2¬∞ semestre de 2025 - GTIM",
                    responsavel: "Reuni√£o Intersetorial",
                    acoes_pse_correspondentes: "Reuni√£o Intersetorial",
                    registro: "Ficha de Atividade Coletiva e-SUS"
                }
            ],
            "esf_sao_mateus": [
                {
                    escola: "EM Francisco Leite Melo",
                    acao: "Avaliar resultados das a√ß√µes do 2¬∞ semestre de 2025 - GTIM",
                    responsavel: "Reuni√£o Intersetorial",
                    acoes_pse_correspondentes: "Reuni√£o Intersetorial",
                    registro: "Ficha de Atividade Coletiva e-SUS"
                }
            ]
        };
        
        // --- NOVO: DADOS NUM√âRICOS DE CAMANDUCAIA (eSF) ATUALIZADOS ---
        
        // DADOS BRUTOS C7 (para facilitar a leitura e atualiza√ß√£o)
        const C7_DATA_CENTRO = { cervicalNum: 162, cervicalDen: 704, consultNum: 93, consultDen: 923, mammoNum: 42, mammoDen: 328, hpvNum: 25, hpvDen: 77 };
        const C7_DATA_CRUZEIRO = { cervicalNum: 282, cervicalDen: 815, consultNum: 145, consultDen: 1107, mammoNum: 56, mammoDen: 345, hpvNum: 69, hpvDen: 120 };
        const C7_DATA_LOTEAMENTO = { cervicalNum: 375, cervicalDen: 996, consultNum: 270, consultDen: 1325, mammoNum: 122, mammoDen: 413, hpvNum: 114, hpvDen: 133 };
        const C7_DATA_MONTE_VERDE = { cervicalNum: 287, cervicalDen: 967, consultNum: 47, consultDen: 1254, mammoNum: 58, mammoDen: 408, hpvNum: 57, hpvDen: 132 };
        const C7_DATA_PONTE_NOVA = { cervicalNum: 142, cervicalDen: 621, consultNum: 48, consultDen: 816, mammoNum: 21, mammoDen: 259, hpvNum: 45, hpvDen: 109 };
        const C7_DATA_QUEDAS_VERDES = { cervicalNum: 239, cervicalDen: 596, consultNum: 51, consultDen: 793, mammoNum: 83, mammoDen: 269, hpvNum: 47, hpvDen: 101 };
        const C7_DATA_SAO_MATEUS = { cervicalNum: 168, cervicalDen: 655, consultNum: 76, consultDen: 845, mammoNum: 103, mammoDen: 336, hpvNum: 56, hpvDen: 99 };
        
        // DADOS BRUTOS C1-C6 (com os novos valores)
        const CAMANDUCAIA_ESF_NUMERICAL_DATA = {
            "esf_centro": (() => {
                const c1 = { num: 586, den: 2817 }; 
                const c2 = { num: 120, den: 6 }; 
                const c3 = { num: 138, den: 3 }; 
                const c4 = { num: 11525, den: 164 }; 
                const c5 = { num: 26525, den: 355 }; 
                const c6 = { num: 32025, den: 543 }; 

                const resultC1 = calculateIndicatorResult('C1', c1.num, c1.den); 
                const resultC2 = calculateIndicatorResult('C2', c2.num, c2.den); 
                const resultC3 = calculateIndicatorResult('C3', c3.num, c3.den);
                const resultC4 = calculateIndicatorResult('C4', c4.num, c4.den);
                const resultC5 = calculateIndicatorResult('C5', c5.num, c5.den);
                const resultC6 = calculateIndicatorResult('C6', c6.num, c6.den);
                const c7Result = calculateC7(C7_DATA_CENTRO);
                
                // M√©dia para score (todos em %)
                const indicators = [resultC1, resultC2, resultC3, resultC4, resultC5, resultC6, c7Result.result];
                const score = indicators.reduce((a, b) => a + b, 0) / 7;

                return {
                    score: score, 
                    classification: classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL'), 
                    "C1": { num: c1.num, den: c1.den, result: resultC1, status: classifyScore(resultC1, ESF_INDICATOR_METADATA.C1.criteria, 'C1') },
                    "C2": { num: c2.num, den: c2.den, result: resultC2, status: classifyScore(resultC2, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, 
                    "C3": { num: c3.num, den: c3.den, result: resultC3, status: classifyScore(resultC3, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, 
                    "C4": { num: c4.num, den: c4.den, result: resultC4, status: classifyScore(resultC4, ESF_INDICATOR_METADATA.C4.criteria, 'C4') },
                    "C5": { num: c5.num, den: c5.den, result: resultC5, status: classifyScore(resultC5, ESF_INDICATOR_METADATA.C5.criteria, 'C5') },
                    "C6": { num: c6.num, den: c6.den, result: resultC6, status: classifyScore(resultC6, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, 
                    "C7": { ...c7Result }
                };
            })(),
             "esf_cruzeiro": (() => {
                const c1 = { num: 662, den: 2678 };
                const c2 = { num: 300, den: 11 };
                const c3 = { num: 195, den: 4 };
                const c4 = { num: 16140, den: 204 };
                const c5 = { num: 38875, den: 459 };
                const c6 = { num: 41575, den: 641 };

                const resultC1 = calculateIndicatorResult('C1', c1.num, c1.den); 
                const resultC2 = calculateIndicatorResult('C2', c2.num, c2.den); 
                const resultC3 = calculateIndicatorResult('C3', c3.num, c3.den);
                const resultC4 = calculateIndicatorResult('C4', c4.num, c4.den);
                const resultC5 = calculateIndicatorResult('C5', c5.num, c5.den);
                const resultC6 = calculateIndicatorResult('C6', c6.num, c6.den);

                const c7Result = calculateC7(C7_DATA_CRUZEIRO);
                
                const indicators = [resultC1, resultC2, resultC3, resultC4, resultC5, resultC6, c7Result.result];
                const score = indicators.reduce((a, b) => a + b, 0) / 7;

                return {
                    score: score, 
                    classification: classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL'), 
                    "C1": { num: c1.num, den: c1.den, result: resultC1, status: classifyScore(resultC1, ESF_INDICATOR_METADATA.C1.criteria, 'C1') },
                    "C2": { num: c2.num, den: c2.den, result: resultC2, status: classifyScore(resultC2, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, 
                    "C3": { num: c3.num, den: c3.den, result: resultC3, status: classifyScore(resultC3, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, 
                    "C4": { num: c4.num, den: c4.den, result: resultC4, status: classifyScore(resultC4, ESF_INDICATOR_METADATA.C4.criteria, 'C4') }, // CORRIGIDO: ESF_INDICATOR_METADRA para ESF_INDICATOR_METADATA
                    "C5": { num: c5.num, den: c5.den, result: resultC5, status: classifyScore(resultC5, ESF_INDICATOR_METADATA.C5.criteria, 'C5') },
                    "C6": { num: c6.num, den: c6.den, result: resultC6, status: classifyScore(resultC6, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, 
                    "C7": { ...c7Result }
                };
            })(),
            "esf_loteamento": (() => {
                const c1 = { num: 944, den: 2678 };
                const c2 = { num: 80, den: 7 };
                const c3 = { num: 534, den: 8 };
                const c4 = { num: 21590, den: 297 };
                const c5 = { num: 43925, den: 616 };
                const c6 = { num: 36875, den: 614 };

                const resultC1 = calculateIndicatorResult('C1', c1.num, c1.den); 
                const resultC2 = calculateIndicatorResult('C2', c2.num, c2.den); 
                const resultC3 = calculateIndicatorResult('C3', c3.num, c3.den);
                const resultC4 = calculateIndicatorResult('C4', c4.num, c4.den);
                const resultC5 = calculateIndicatorResult('C5', c5.num, c5.den);
                const resultC6 = calculateIndicatorResult('C6', c6.num, c6.den);
                const c7Result = calculateC7(C7_DATA_LOTEAMENTO);
                
                const indicators = [resultC1, resultC2, resultC3, resultC4, resultC5, resultC6, c7Result.result];
                const score = indicators.reduce((a, b) => a + b, 0) / 7;

                return {
                    score: score, 
                    classification: classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL'), 
                    "C1": { num: c1.num, den: c1.den, result: resultC1, status: classifyScore(resultC1, ESF_INDICATOR_METADATA.C1.criteria, 'C1') },
                    "C2": { num: c2.num, den: c2.den, result: resultC2, status: classifyScore(resultC2, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, 
                    "C3": { num: c3.num, den: c3.den, result: resultC3, status: classifyScore(resultC3, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, 
                    "C4": { num: c4.num, den: c4.den, result: resultC4, status: classifyScore(resultC4, ESF_INDICATOR_METADATA.C4.criteria, 'C4') },
                    "C5": { num: c5.num, den: c5.den, result: resultC5, status: classifyScore(resultC5, ESF_INDICATOR_METADATA.C5.criteria, 'C5') },
                    "C6": { num: c6.num, den: c6.den, result: resultC6, status: classifyScore(resultC6, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, 
                    "C7": { ...c7Result }
                };
            })(),
            "esf_monte_verde": (() => {
                const c1 = { num: 406, den: 2286 }; 
                const c2 = { num: 1480, den: 21 }; 
                const c3 = { num: 541, den: 13 };
                const c4 = { num: 11385, den: 164 };
                const c5 = { num: 26750, den: 363 };
                const c6 = { num: 30475, den: 552 };

                const resultC1 = calculateIndicatorResult('C1', c1.num, c1.den); 
                const resultC2 = calculateIndicatorResult('C2', c2.num, c2.den); 
                const resultC3 = calculateIndicatorResult('C3', c3.num, c3.den);
                const resultC4 = calculateIndicatorResult('C4', c4.num, c4.den);
                const resultC5 = calculateIndicatorResult('C5', c5.num, c5.den);
                const resultC6 = calculateIndicatorResult('C6', c6.num, c6.den);
                const c7Result = calculateC7(C7_DATA_MONTE_VERDE);
                
                const indicators = [resultC1, resultC2, resultC3, resultC4, resultC5, resultC6, c7Result.result];
                const score = indicators.reduce((a, b) => a + b, 0) / 7;

                return {
                    score: score, 
                    classification: classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL'), 
                    "C1": { num: c1.num, den: c1.den, result: resultC1, status: classifyScore(resultC1, ESF_INDICATOR_METADATA.C1.criteria, 'C1') },
                    "C2": { num: c2.num, den: c2.den, result: resultC2, status: classifyScore(resultC2, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, 
                    "C3": { num: c3.num, den: c3.den, result: resultC3, status: classifyScore(resultC3, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, 
                    "C4": { num: c4.num, den: c4.den, result: resultC4, status: classifyScore(resultC4, ESF_INDICATOR_METADATA.C4.criteria, 'C4') },
                    "C5": { num: c5.num, den: c5.den, result: resultC5, status: classifyScore(resultC5, ESF_INDICATOR_METADATA.C5.criteria, 'C5') },
                    "C6": { num: c6.num, den: c6.den, result: resultC6, status: classifyScore(resultC6, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, 
                    "C7": { ...c7Result }
                };
            })(),
            "esf_ponte_nova": (() => {
                const c1 = { num: 532, den: 1243 };
                const c2 = { num: 60, den: 7 };
                const c3 = { num: 247, den: 6 };
                const c4 = { num: 9235, den: 139 };
                const c5 = { num: 21500, den: 347 };
                const c6 = { num: 16925, den: 386 };

                const resultC1 = calculateIndicatorResult('C1', c1.num, c1.den); 
                const resultC2 = calculateIndicatorResult('C2', c2.num, c2.den); 
                const resultC3 = calculateIndicatorResult('C3', c3.num, c3.den);
                const resultC4 = calculateIndicatorResult('C4', c4.num, c4.den);
                const resultC5 = calculateIndicatorResult('C5', c5.num, c5.den);
                const resultC6 = calculateIndicatorResult('C6', c6.num, c6.den);
                const c7Result = calculateC7(C7_DATA_PONTE_NOVA);
                
                const indicators = [resultC1, resultC2, resultC3, resultC4, resultC5, resultC6, c7Result.result];
                const score = indicators.reduce((a, b) => a + b, 0) / 7;

                return {
                    score: score, 
                    classification: classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL'), 
                    "C1": { num: c1.num, den: c1.den, result: resultC1, status: classifyScore(resultC1, ESF_INDICATOR_METADATA.C1.criteria, 'C1') },
                    "C2": { num: c2.num, den: c2.den, result: resultC2, status: classifyScore(resultC2, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, 
                    "C3": { num: c3.num, den: c3.den, result: resultC3, status: classifyScore(resultC3, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, 
                    "C4": { num: c4.num, den: c4.den, result: resultC4, status: classifyScore(resultC4, ESF_INDICATOR_METADATA.C4.criteria, 'C4') },
                    "C5": { num: c5.num, den: c5.den, result: resultC5, status: classifyScore(resultC5, ESF_INDICATOR_METADATA.C5.criteria, 'C5') },
                    "C6": { num: c6.num, den: c6.den, result: resultC6, status: classifyScore(resultC6, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, 
                    "C7": { ...c7Result }
                };
            })(),
            "esf_quedas_verdes": (() => {
                const c1 = { num: 377, den: 1408 };
                const c2 = { num: 200, den: 13 };
                const c3 = { num: 355, den: 10 };
                const c4 = { num: 11760, den: 186 };
                const c5 = { num: 29575, den: 422 };
                const c6 = { num: 26925, den: 472 };

                 const resultC1 = calculateIndicatorResult('C1', c1.num, c1.den); 
                const resultC2 = calculateIndicatorResult('C2', c2.num, c2.den); 
                const resultC3 = calculateIndicatorResult('C3', c3.num, c3.den);
                const resultC4 = calculateIndicatorResult('C4', c4.num, c4.den);
                const resultC5 = calculateIndicatorResult('C5', c5.num, c5.den);
                const resultC6 = calculateIndicatorResult('C6', c6.num, c6.den);
                const c7Result = calculateC7(C7_DATA_QUEDAS_VERDES);
                
                const indicators = [resultC1, resultC2, resultC3, resultC4, resultC5, resultC6, c7Result.result];
                const score = indicators.reduce((a, b) => a + b, 0) / 7;

                return {
                    score: score, 
                    classification: classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL'), 
                    "C1": { num: c1.num, den: c1.den, result: resultC1, status: classifyScore(resultC1, ESF_INDICATOR_METADATA.C1.criteria, 'C1') },
                    "C2": { num: c2.num, den: c2.den, result: resultC2, status: classifyScore(resultC2, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, 
                    "C3": { num: c3.num, den: c3.den, result: resultC3, status: classifyScore(resultC3, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, 
                    "C4": { num: c4.num, den: c4.den, result: resultC4, status: classifyScore(resultC4, ESF_INDICATOR_METADATA.C4.criteria, 'C4') },
                    "C5": { num: c5.num, den: c5.den, result: resultC5, status: classifyScore(resultC5, ESF_INDICATOR_METADATA.C5.criteria, 'C5') },
                    "C6": { num: c6.num, den: c6.den, result: resultC6, status: classifyScore(resultC6, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, 
                    "C7": { ...c7Result }
                };
            })(),
            "esf_sao_mateus": (() => {
                const c1 = { num: 475, den: 2848 };
                const c2 = { num: 400, den: 10 };
                const c3 = { num: 429, den: 9 };
                const c4 = { num: 16670, den: 197 };
                const c5 = { num: 35925, den: 455 };
                const c6 = { num: 37125, den: 617 };

                 const resultC1 = calculateIndicatorResult('C1', c1.num, c1.den); 
                const resultC2 = calculateIndicatorResult('C2', c2.num, c2.den); 
                const resultC3 = calculateIndicatorResult('C3', c3.num, c3.den);
                const resultC4 = calculateIndicatorResult('C4', c4.num, c4.den);
                const resultC5 = calculateIndicatorResult('C5', c5.num, c5.den);
                const resultC6 = calculateIndicatorResult('C6', c6.num, c6.den);
                const c7Result = calculateC7(C7_DATA_SAO_MATEUS);
                
                const indicators = [resultC1, resultC2, resultC3, resultC4, resultC5, resultC6, c7Result.result];
                const score = indicators.reduce((a, b) => a + b, 0) / 7;

                return {
                    score: score, 
                    classification: classifyScore(score, ["√ìtimo: >75%"], 'GLOBAL'), 
                    "C1": { num: c1.num, den: c1.den, result: resultC1, status: classifyScore(resultC1, ESF_INDICATOR_METADATA.C1.criteria, 'C1') },
                    "C2": { num: c2.num, den: c2.den, result: resultC2, status: classifyScore(resultC2, ESF_INDICATOR_METADATA.C2.criteria, 'C2') }, 
                    "C3": { num: c3.num, den: c3.den, result: resultC3, status: classifyScore(resultC3, ESF_INDICATOR_METADATA.C3.criteria, 'C3') }, 
                    "C4": { num: c4.num, den: c4.den, result: resultC4, status: classifyScore(resultC4, ESF_INDICATOR_METADATA.C4.criteria, 'C4') },
                    "C5": { num: c5.num, den: c5.den, result: resultC5, status: classifyScore(resultC5, ESF_INDICATOR_METADATA.C5.criteria, 'C5') },
                    "C6": { num: c6.num, den: c6.den, result: resultC6, status: classifyScore(resultC6, ESF_INDICATOR_METADATA.C6.criteria, 'C6') }, 
                    "C7": { ...c7Result }
                };
            })()
        };

        // --- MOCK DE DADOS NUM√âRICOS PARA B1-B6 (eSB) - DADOS ATUALIZADOS! ---
        const MOCK_ESB_RESULTS = {
            "esb_cruzeiro": {
                // B1: (256 / 6112) * 100 = 4.19% -> Bom (3% < 4.19% ‚â§ 5%)
                B1: { num: 256, den: 6112, result: 0 }, 
                // B2: (148 / 180) * 100 = 82.22% -> √ìtimo (> 75%)
                B2: { num: 148, den: 180, result: 0 }, 
                // B3: (114 / 1434) * 100 = 7.95% -> Regular (< 8%)
                B3: { num: 114, den: 1434, result: 0 }, 
                // B4: (32 / 548) * 100 = 5.84% -> √ìtimo (> 1%)
                B4: { num: 32, den: 548, result: 0 }, 
                // B5: (698 / 3354) * 100 = 20.81% -> Regular (< 40%)
                B5: { num: 698, den: 3354, result: 0 }, 
                // B6: (6 / 330) * 100 = 1.81% -> Regular (‚â§ 3%)
                B6: { num: 6, den: 330, result: 0 }
            },
            "esb_monte_verde": {
                // B1: (24 / 3190) * 100 = 0.75% -> Regular (‚â§ 1%)
                B1: { num: 24, den: 3190, result: 0 }, 
                // B2: (10 / 12) * 100 = 83.33% -> √ìtimo (> 75%)
                B2: { num: 10, den: 12, result: 0 }, 
                // B3: (4 / 80) * 100 = 5.00% -> Regular (< 8%)
                B3: { num: 4, den: 80, result: 0 }, 
                // B4: (1 / 292) * 100 = 0.34% -> Suficiente (> 0.25% e ‚â§ 0.5%)
                B4: { num: 1, den: 292, result: 0 }, 
                // B5: (28 / 246) * 100 = 11.38% -> Regular (< 40%)
                B5: { num: 28, den: 246, result: 0 }, 
                // B6: (0 / 17) * 100 = 0.00% -> Regular (‚â§ 3%)
                B6: { num: 0, den: 17, result: 0 }
            }
        };
        // A prop 'result: 0' √© apenas um placeholder. A fun√ß√£o getEsbIndicatorsData recalcula o result.

        // --- MOCK DE DADOS NUM√âRICOS PARA M1-M2 (eMulti) ---
        // ATUALIZADO COM OS DADOS FORNECIDOS PELO USU√ÅRIO
        const MOCK_EMULTI_RESULTS = {
            "emulti_01": { 
                // M1: 3169 / 890 = 3.56
                M1: { num: 3169, den: 890, result: 0 }, 
                // M2: (111 / 2992) * 100 = 3.71%
                M2: { num: 111, den: 2992, result: 0 } 
            },
            "emulti_02": { 
                // M1: 2608 / 413 = 6.31
                M1: { num: 2608, den: 413, result: 0 }, 
                // M2: (6 / 2222) * 100 = 0.27%
                M2: { num: 6, den: 2222, result: 0 } 
            },
            "emulti_03": { 
                // M1: 808 / 178 = 4.54
                M1: { num: 808, den: 178, result: 0 }, 
                // M2: (8 / 1261) * 100 = 0.63%
                M2: { num: 8, den: 1261, result: 0 } 
            }
        };
        // --- DATA OBJECTS ---

        const CAMANDUCAIA_VINCULO_DATA = {
            "esf_centro": {
                cadTotal: 2267, cadIndOnly: 68, cadComplete: 2154, cadIncomplete: 113,
                param: 2500, acompTotal: 2082
            },
            "esf_cruzeiro": {
                cadTotal: 3026, cadIndOnly: 91, cadComplete: 2935, cadIncomplete: 91,
                param: 2500, acompTotal: 2896
            },
            "esf_loteamento": {
                cadTotal: 3466, cadIndOnly: 0, cadComplete: 3466, cadIncomplete: 0,
                param: 2500, acompTotal: 2756
            },
            "esf_monte_verde": {
                cadTotal: 3217, cadIndOnly: 0, cadComplete: 3217, cadIncomplete: 0,
                param: 2500, acompTotal: 2876
            },
            "esf_ponte_nova": {
                cadTotal: 2153, cadIndOnly: 0, cadComplete: 2131, cadIncomplete: 22,
                param: 2500, acompTotal: 1522
            },
            "esf_quedas_verdes": {
                cadTotal: 2195, cadIndOnly: 66, cadComplete: 2129, cadIncomplete: 66,
                param: 2500, acompTotal: 1939
            },
            "esf_sao_mateus": {
                cadTotal: 2410, cadIndOnly: 49, cadComplete: 2347, cadIncomplete: 73,
                param: 2500, acompTotal: 2195
            }
        };

        // --- DATA STORE (Mantido) ---
        function createEsfMockDataForMun(munId, teamId, teamName, score, classification, population) {
            const indData = getIndicatorDataByTeamType(munId, 'esf_eap', teamId, score);
            return {
                teamName,
                population: population,
                classification: indData.classification,
                score: indData.score,
                indicators: indData.indicators
            };
        }
        function createEsbMockDataForMun(munId, teamId, teamName, score, population) {
            const indData = getIndicatorDataByTeamType(munId, 'esb', teamId, score);
             return {
                teamName,
                population: population,
                classification: indData.classification,
                score: indData.score,
                indicators: indData.indicators
            };
        }
        function createEmultiMockDataForMun(munId, teamId, teamName, score, population) {
             const indData = getIndicatorDataByTeamType(munId, 'emulti', teamId, score);
             return {
                teamName,
                population: population,
                classification: indData.classification,
                score: indData.score,
                indicators: indData.indicators
            };
        }
        
        const municipalityData = {
            "camanducaia": {
                name: "Camanducaia - MG",
                password: '022025',
                population: 18500,
                defaultTeamType: "emulti", // Inicia emulti por conveni√™ncia
                teams: {
                    "esf_eap": {
                        "esf_centro": createEsfMockDataForMun("camanducaia", "esf_centro", "eSF Centro", 70.2, "Bom", 4000), 
                        "esf_cruzeiro": createEsfMockDataForMun("camanducaia", "esf_cruzeiro", "eSF Cruzeiro", 65.5, "Bom", 3500),
                        "esf_loteamento": createEsfMockDataForMun("camanducaia", "esf_loteamento", "eSF Loteamento", 55.0, "Bom", 3200), 
                        "esf_monte_verde": createEsfMockDataForMun("camanducaia", "esf_monte_verde", "eSF Monte Verde", 78.1, "√ìtimo", 2800), 
                        "esf_ponte_nova": createEsfMockDataForMun("camanducaia", "esf_ponte_nova", "eSF Ponte Nova", 45.9, "Suficiente", 2500), 
                        "esf_quedas_verdes": createEsfMockDataForMun("camanducaia", "esf_quedas_verdes", "eSF Quedas Verdes", 35.5, "Suficiente", 2000), 
                        "esf_sao_mateus": createEsfMockDataForMun("camanducaia", "esf_sao_mateus", "eSF S√£o Mateus", 72.8, "Bom", 4200)
                    },
                    "esb": { 
                        // O score real ser√° recalculado internamente
                        "esb_cruzeiro": createEsbMockDataForMun("camanducaia", "esb_cruzeiro", "eSB Cruzeiro", 0, 3800),
                        "esb_monte_verde": createEsbMockDataForMun("camanducaia", "esb_monte_verde", "eSB Monte Verde", 0, 2100) 
                    },
                    "emulti": { 
                        // Os scores (0) ser√£o recalculados por getIndicatorDataByTeamType
                        "emulti_01": createEmultiMockDataForMun("camanducaia", "emulti_01", "eMulti 01", 0, 10000),
                        "emulti_02": createEmultiMockDataForMun("camanducaia", "emulti_02", "eMulti 02", 0, 8000),
                        "emulti_03": createEmultiMockDataForMun("camanducaia", "emulti_03", "eMulti 03", 0, 5000)
                    }
                }
            },
            // Simplified data for other municipalities
            "cachoeira_de_minas": { 
                name: "Cachoeira de Minas - MG", 
                password: '012025', 
                population: 11000, 
                defaultTeamType: "esf_eap", 
                teams: { 
                    "esf_eap": { 
                        "esf_cachoeira_i": createEsfMockDataForMun("cachoeira_de_minas", "esf_cachoeira_i", "eSF Cachoeira de Minas I", 85.5, "√ìtimo", 2200) 
                    }, 
                    "esb": { "esb_cachoeira": createEsbMockDataForMun("cachoeira_de_minas", "esb_cachoeira", "eSB Cachoeira de Minas", 0, 2000) }, 
                    "emulti": { "nasf_cachoeira": createEmultiMockDataForMun("cachoeira_de_minas", "nasf_cachoeira", "NASF Cachoeira de Minas", 80.00, 5000) } 
                } 
            },
            "corrego_do_bom_jesus": { 
                name: "C√≥rrego do Bom Jesus - MG", 
                password: '032025', 
                population: 4200, 
                defaultTeamType: "esf_eap", 
                teams: { 
                    "esf_eap": { 
                        "esf_central": createEsfMockDataForMun("corrego_do_bom_jesus", "esf_central", "eSF Central", 30.5, "Suficiente", 1500) 
                    }, 
                    "esb": { "esb_01": createEsbMockDataForMun("corrego_do_bom_jesus", "esb_01", "eSB 01", 0, 1500) }, 
                    "emulti": { "emulti_01": createEmultiMockDataForMun("corrego_do_bom_jesus", "emulti_01", "eMulti Rural", 55.00, 2000) } 
                } 
            },
            "delfim_moreira": { 
                name: "Delfim Moreira - MG", 
                password: '042025', 
                population: 8500, 
                defaultTeamType: "esf_eap", 
                teams: { 
                    "esf_eap": { 
                        "esf_central": createEsfMockDataForMun("delfim_moreira", "esf_central", "eSF Central", 95.0, "√ìtimo", 3000) 
                    }, 
                    "esb": { "esb_01": createEsbMockDataForMun("delfim_moreira", "esb_01", "eSB 01", 0, 3000) }, 
                    "emulti": { "emulti_01": createEmultiMockDataForMun("delfim_moreira", "emulti_01", "eMulti Sede", 90.00, 4000) } 
                } 
            },
            "itapeva": { 
                name: "Itapeva - MG", 
                password: '052025', 
                population: 13000, 
                defaultTeamType: "esf_eap", 
                teams: { 
                    "esf_eap": { 
                        "esf_central": createEsfMockDataForMun("itapeva", "esf_central", "eSF Central", 55.0, "Bom", 2800) 
                    }, 
                    "esb": { "esb_01": createEsbMockDataForMun("itapeva", "esb_01", "eSB 01", 0, 3000) }, 
                    "emulti": { "emulti_01": createEmultiMockDataForMun("itapeva", "emulti_01", "eMulti 01", 68.00, 5000) } 
                } 
            },
            "pedralva": { 
                name: "Pedralva - MG", 
                password: '062025', 
                population: 11000, 
                defaultTeamType: "esf_eap", 
                teams: { 
                    "esf_eap": { 
                        "esf_sede": createEsfMockDataForMun("pedralva", "esf_sede", "eSF Sede", 70.0, "Bom", 2500) 
                    }, 
                    "esb": { "esb_01": createEsbMockDataForMun("pedralva", "esb_01", "eSB 01", 0, 2500) }, 
                    "emulti": { "emulti_01": createEmultiMockDataForMun("pedralva", "emulti_01", "eMulti Rural", 75.00, 3000) } 
                } 
            }
        };
        
        // --- VIEWS E L√ìGICAS ADICIONAIS ---

        // L√ìGICA DE V√çNCULO E ACOMPANHAMENTO (Mantido)

        function renderVinculoAcompanhamento(data) {
             // CORRE√á√ÉO: Usar Intl.NumberFormat para garantir a formata√ß√£o correta
             const numberFormatter = new Intl.NumberFormat('pt-BR');
             
             // Remove v√≠rgulas (usado no mock de popula√ß√£o) e converte para n√∫mero
             const popTarget = parseInt(data.population.toString().replace(/,/g, ''));
             
             // MOCK DATA (Fixa para Camanducaia, mas poderia ser din√¢mica por equipe)
             const mockVinculoData = {
                 popAdscrita: popTarget,
                 cadIndividual: Math.floor(popTarget * 0.95), // 95% total cadastrado
                 cadIndividualOnly: Math.floor(popTarget * 0.15), // 15% s√≥ individual
                 cadComplete: Math.floor(popTarget * 0.80), // 80% completo
                 
                 acompParametro: popTarget,
                 acompPessoasTotal: Math.floor(popTarget * 0.65), // 65% acompanhado
             };

             // 1. DIMENS√ÉO CADASTRO (M√°x 3.00)
             const cadCompleteRatio = mockVinculoData.cadComplete / mockVinculoData.popAdscrita;
             const cadIndividualOnlyRatio = mockVinculoData.cadIndividualOnly / mockVinculoData.popAdscrita;
             const cadIncomplete = mockVinculoData.popAdscrita - mockVinculoData.cadComplete; // Novo c√°lculo
             
             // Score C√°lculo: (Cad. Completo * 1.5) + (S√≥ Ind. * 0.75)
             let scoreCad = (cadCompleteRatio * 1.5) + (cadIndividualOnlyRatio * 0.75);
             scoreCad = Math.min(scoreCad, 3.00); // Limita ao m√°ximo de 3.00

             // Classifica√ß√£o Cadastro
             let classificacaoCad = 'Regular';
             if (scoreCad >= 2.5) classificacaoCad = '√ìtimo';
             else if (scoreCad >= 1.5) classificacaoCad = 'Bom';
             else if (scoreCad >= 0.75) classificacaoCad = 'Suficiente';

             // 2. DIMENS√ÉO ACOMPANHAMENTO (M√°x 7.00)
             const acompRatio = mockVinculoData.acompPessoasTotal / mockVinculoData.acompParametro;
             
             // Score C√°lculo: Acompanhamento (Ratio * 7.00)
             let scoreAcomp = acompRatio * 7.00;
             scoreAcomp = Math.min(scoreAcomp, 7.00); // Limita ao m√°ximo de 7.00

             // Classifica√ß√£o Acompanhamento
             let classificacaoAcomp = 'Regular';
             if (scoreAcomp >= 5.25) classificacaoAcomp = '√ìtimo'; // 75% da meta
             else if (scoreAcomp >= 3.5) classificacaoAcomp = 'Bom'; // 50% da meta
             else if (scoreAcomp >= 1.75) classificacaoAcomp = 'Suficiente'; // 25% da meta
             
             // 3. SCORE FINAL
             const scoreFinal = scoreCad + scoreAcomp;
             let classificacaoFinal = 'Regular';
             if (scoreFinal >= 7.5) classificacaoFinal = '√ìtimo'; // 75% da meta (10)
             else if (scoreFinal >= 5.0) classificacaoFinal = 'Bom';
             else if (scoreFinal >= 2.5) classificacaoFinal = 'Suficiente';

             // --- Renderiza√ß√£o ---
             
             // Dimens√£o V√≠nculo
             document.getElementById('vinculo-cad-individual').innerText = numberFormatter.format(mockVinculoData.cadIndividual);
             document.getElementById('vinculo-cad-individual-only').innerText = numberFormatter.format(mockVinculoData.cadIndividualOnly);
             document.getElementById('vinculo-cad-complete').innerText = numberFormatter.format(mockVinculoData.cadComplete);
             document.getElementById('vinculo-cad-incomplete').innerText = numberFormatter.format(cadIncomplete);
             
             document.getElementById('vinculo-score-cad-val').innerText = scoreCad.toFixed(2).replace('.', ',');
             document.getElementById('vinculo-resultado-cad').innerText = `O percentual de cadastros completos √© de ${ (cadCompleteRatio * 100).toFixed(1).replace('.', ',') }% e de cadastros incompletos √© de ${ ((mockVinculoData.cadIndividualOnly / mockVinculoData.popAdscrita) * 100).toFixed(1).replace('.', ',') }%.`;
             document.getElementById('vinculo-classificacao-cad').innerText = `Classifica√ß√£o: ${classificacaoCad}`;
             document.getElementById('vinculo-classificacao-cad').className = `text-sm mt-1 font-bold ${STATUS_COLORS[classificacaoCad]?.text}`;


             // Dimens√£o Acompanhamento
             // TEXTO ALTERADO AQUI
             document.getElementById('acomp-parametro').innerText = numberFormatter.format(mockVinculoData.acompParametro);
             // TEXTO ALTERADO AQUI
             document.getElementById('acomp-pessoas-total').innerText = numberFormatter.format(mockVinculoData.acompPessoasTotal);
             
             document.getElementById('vinculo-score-acomp-val').innerText = scoreAcomp.toFixed(2).replace('.', ',');
             document.getElementById('acomp-resultado-acomp').innerText = `A propor√ß√£o de pessoas com acompanhamento adequado no quadrimestre √© de ${ (acompRatio * 100).toFixed(1).replace('.', ',') }%.`;
             document.getElementById('acomp-classificacao-acomp').innerText = `Classifica√ß√£o: ${classificacaoAcomp}`;
             document.getElementById('acomp-classificacao-acomp').className = `text-sm mt-1 font-bold ${STATUS_COLORS[classificacaoAcomp]?.text}`;

             // Score Final
             document.getElementById('vinculo-score-final-val').innerText = scoreFinal.toFixed(2).replace('.', ',');
             document.getElementById('vinculo-classificacao-final').innerText = classificacaoFinal;
             document.getElementById('vinculo-classificacao-final').className = `text-4xl font-extrabold mt-1 ${STATUS_COLORS[classificacaoFinal]?.text}`;
        }


        // L√ìGICA DE POEPS - Planejamento Mensal (Mantido)
        
        const POEPS_MONTHLY_PLAN_DATA = [
            { id: 1, indicator: "Pr√°ticas Corporais / Atividade F√≠sica", quantity: "797 Participantes", action: "Manter Grupos de Atividade F√≠sica e Promover 'Dia D' de Movimento", responsible: "ACSs, Educador F√≠sico, Enfermeiros", registration: "Ficha de Atividade Coletiva (e-SUS), registro de participa√ß√£o" },
            { id: 2, indicator: "Educa√ß√£o em Sa√∫de", quantity: "02 A√ß√µes/Equipe (Total: 14 a√ß√µes)", action: "Realizar a√ß√µes tem√°ticas (Ex: C√¢ncer Colorretal, Autismo) em salas de espera e grupos de gestantes.", responsible: "Enfermeiros, M√©dicos, ACSs, Apoio eMulti", registration: "Ficha de Atividade Coletiva (e-SUS), registro de tema e p√∫blico-alvo" },
            { id: 3, indicator: "Marcadores de Consumo Alimentar", quantity: "203 Registros", action: "Aplicar o inqu√©rito de MCA/VIGITEL em todos os pacientes hipertensos e diab√©ticos nas consultas agendadas.", responsible: "Nutricionista, ACSs", registration: "Ficha de Atendimento Individual (e-SUS) - Marcadores de Consumo Alimentar" },
            { id: 4, indicator: "Comit√™ de Pol√≠ticas de Equidades", quantity: "01 A√ß√£o Obrigat√≥ria", action: "Reuni√£o de Matriciamento com tema 'Racismo Institucional na Sa√∫de' e Revis√£o do Diagn√≥stico Situacional do Munic√≠pio.", responsible: "Coordena√ß√£o APS, Apoio Institucional, Equipe Matriciadora", registration: "Ata/Lista de presen√ßa com registro da a√ß√£o no e-SUS" },
            { id: 5, indicator: "Acompanhamento do estado nutricional (Peso e Altura)", quantity: "1.770 Mensura√ß√µes", action: "Realizar mensura√ß√£o de peso e altura em 100% dos pacientes nos fluxos de Hipertens√£o, Diabetes e Sa√∫de da Crian√ßa.", responsible: "Enfermeiros, T√©cnicos de Enfermagem, ACSs", registration: "Ficha de Atendimento Individual (e-SUS) - Dados Antropom√©tricos" },
            { id: 6, indicator: "Orienta√ß√£o Sexual / Identidade de G√™nero", quantity: "M√°ximo de Atualiza√ß√µes", action: "Capacitar ACSs e realizar busca ativa focada em adolescentes e adultos jovens para preenchimento dos campos de ra√ßa/cor e Orienta√ß√£o Sexual/Identidade de G√™nero no cadastro individual.", responsible: "ACSs, Apoio Institucional", registration: "Ficha de Cadastro Individual (e-SUS) - Monitoramento de Preenchimento" },
            { id: 7, indicator: "Atendimento Individuais √† Pessoas Pretas e Pardas", quantity: "Aumentar em 5%", action: "Garantir que a classifica√ß√£o de ra√ßa/cor seja perguntada e registrada corretamente na recep√ß√£o e em todos os atendimentos, focando no monitoramento da equidade de acesso.", responsible: "Recep√ß√£o, ACSs, Profissionais de Sa√∫de", registration: "Ficha de Atendimento Individual (e-SUS) - Monitoramento de Ra√ßa/Cor" },
            { id: 8, indicator: "PICS", quantity: "28 Procedimentos", action: "Ofertar pr√°ticas integrativas (Ex: Auriculoterapia, Shantala, Yoga) em dias e hor√°rios acess√≠veis para a comunidade. Priorizar pacientes cr√¥nicos e gestantes.", responsible: "Profissionais de Sa√∫de Certificados (e.g., Fisioterapeuta, Enfermeiro)", registration: "Ficha de Atendimento Individual/Coletiva (e-SUS) - PICS" }
        ];

        function renderPoepsMonthlyPlan(data) {
             const monthKey = getCurrentMonthKey();
             const monthName = getCurrentMonthName();
             
             // 1. Atualiza o cabe√ßalho
             document.getElementById('poeps-monthly-plan-header').innerText = `üóìÔ∏è Planejamento Mensal - POEPS (${monthName})`;
             
             // 2. Renderiza o Card de Campanha
             const campaignData = MONTHLY_CAMPAIGNS[monthKey] || { theme: 'Tema N√£o Definido', desc: 'N√£o h√° campanha principal definida para este m√™s.' };
             const campaignCard = document.getElementById('poeps-campaign-card');
             campaignCard.classList.remove('hidden');
             campaignCard.innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="text-4xl">‚≠ê</span>
                    <div>
                        <h4 class="text-xl font-bold text-gray-800">Campanha de Sa√∫de: ${campaignData.theme}</h4>
                        <p class="text-sm text-gray-600">${campaignData.desc}</p>
                    </div>
                </div>
             `;
             
             // 3. Renderiza a tabela de planejamento (Mocada)
             const tableContent = document.getElementById('poeps-monthly-plan-content');
             
             let tableHTML = `
                <h4 class="text-lg font-bold text-gray-800 mb-4">Metas e A√ß√µes Programadas para ${monthName}</h4>
                <div class="overflow-x-auto">
                    <table class="w-full poeps-quarterly-table">
                        <thead>
                            <tr>
                                <th class="sticky-left">Indicador / Descri√ß√£o</th>
                                <th>Meta M√™s (Total/Equipe)</th>
                                <th>A√ß√£o Programada</th>
                                <th>Respons√°vel Principal</th>
                                <th>Registro e Monitoramento</th>
                            </tr>
                        </thead>
                        <tbody>
             `;
             
             POEPS_MONTHLY_PLAN_DATA.forEach(item => {
                 tableHTML += `
                    <tr>
                        <td class="sticky-left font-semibold text-left">${item.id}. ${item.indicator}</td>
                        <td>${item.quantity}</td>
                        <td class="whitespace-normal max-w-xs text-left">${item.action}</td>
                        <td>${item.responsible}</td>
                        <td class="whitespace-normal max-w-xs text-left text-xs text-gray-500">${item.registration}</td>
                    </tr>
                 `;
             });
             
             tableHTML += `
                        </tbody>
                    </table>
                </div>
             `;
             tableContent.innerHTML = tableHTML;
        }

        // L√ìGICA DE POEPS - Avalia√ß√£o Mensal (Mantido)
        
        function renderPoepsMonthlyEvaluation(data) {
            const evalData = MOCK_POEPS_MONTHLY_EVAL;
            const monthName = evalData.month;
            
            document.getElementById('poeps-monthly-eval-month').innerText = monthName;
            
            const tableContent = document.querySelector('#view-poeps-monthly-eval > .bg-white');
            
            let tableHTML = `
                <h4 class="text-lg font-bold text-gray-800 mb-4">Relat√≥rio de Execu√ß√£o do POEPS - ${monthName}/${evalData.year}</h4>
                <div class="overflow-x-auto">
                    <table class="w-full poeps-quarterly-table">
                        <thead>
                            <tr>
                                <th class="sticky-left">Indicador</th>
                                <th>Meta M√™s</th>
                                <th>Realizado no M√™s</th>
                                <th>Status</th>
                                <th>A√ß√£o Necess√°ria</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            evalData.indicators.forEach(item => {
                let status;
                if (item.fulfilled === true) {
                    status = 'Alcan√ßado';
                } else if (item.fulfilled === false) {
                    status = 'N√£o Alcan√ßado';
                } else {
                    status = 'Acompanhamento';
                }
                
                const statusColor = STATUS_COLORS[status];
                
                tableHTML += `
                    <tr>
                        <td class="sticky-left font-semibold text-left">${item.id}. ${item.title}</td>
                        <td>${item.meta}</td>
                        <td>${item.realized}</td>
                        <td class="font-bold ${statusColor.text} ${statusColor.bg} rounded-full text-xs py-1 px-3">${status}</td>
                        <td class="whitespace-normal max-w-xs text-left text-sm text-gray-600">${item.pending}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg">
                    <p class="text-sm text-yellow-800 font-semibold">
                        Aten√ß√£o: Os dados de "Realizado" e "Status" para os Indicadores 4 e 7 s√£o baseados em verifica√ß√£o de registro e n√£o em contagem num√©rica direta.
                    </p>
                </div>
            `;
            tableContent.innerHTML = tableHTML;
        }

        // L√ìGICA DE POEPS - Avalia√ß√£o Quadrimestral (Atual)
        
        function renderPoepsQuarterlyEvaluation(data) {
            const quarterlyData = MOCK_POEPS_Q_EVAL;
            const months = ["Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('poeps-quarterly-months').innerText = months.join(', ');

            const tableContent = document.getElementById('poeps-quarterly-eval-content');
            
            let tableHTML = `
                <h4 class="text-lg font-bold text-gray-800 mb-4">Monitoramento do 3¬∫ Quadrimestre de 2025</h4>
                <div class="overflow-x-auto">
                    <table class="w-full poeps-quarterly-table">
                        <thead>
                            <tr>
                                <th class="sticky-left">Indicador / Meta (Q)</th>
                                ${months.map(m => `<th>${m.substring(0, 3)} (Realizado)</th>`).join('')}
                                <th>Acumulado</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            POEPS_INDICATOR_METADATA.forEach(meta => {
                const key = meta.key;
                const dataRow = quarterlyData[key];

                // Ignora indicadores sem dados mockados para o quadrimestre
                if (!dataRow) return;

                const isNonNumeric = ["Indicador 06", "Indicador 07"].includes(meta.key.substring(0, 12));
                
                let accumulated = 0;
                let status = 'N/A';
                
                if (!isNonNumeric) {
                     // Indicadores Num√©ricos (1, 2, 3, 4, 5, 8)
                     accumulated = dataRow.set + dataRow.out + dataRow.nov + dataRow.dez;
                     const target = meta.target;
                     
                     if (accumulated >= target) {
                         status = 'Alcan√ßado';
                     } else if (accumulated > (target * 0.75)) {
                         status = 'Bom';
                     } else if (accumulated > (target * 0.5)) {
                         status = 'Suficiente';
                     } else {
                         status = 'N√£o Alcan√ßado';
                     }
                } else {
                    // Indicadores de Acompanhamento (6, 7)
                    accumulated = 'Acompanhamento';
                    // Simula√ß√£o baseada na tend√™ncia de aumento (para o mock)
                    const lastMonthData = dataRow.nov;
                    if (key === POEPS_Q_EVAL_MAP[6]) {
                         // Se o √∫ltimo m√™s for "Bom" (p.ex., 686 ID)
                         status = lastMonthData.includes('686') ? 'Bom' : 'Acompanhamento';
                         accumulated = lastMonthData; // Exibe a √∫ltima informa√ß√£o
                    } else if (key === POEPS_Q_EVAL_MAP[7]) {
                         // Se o √∫ltimo m√™s for > 5%
                         status = (parseFloat(lastMonthData.replace('%', '')) >= 5.0) ? '√ìtimo' : 'Acompanhamento';
                         accumulated = lastMonthData; // Exibe a √∫ltima informa√ß√£o
                    }
                }
                
                const statusColor = isNonNumeric ? STATUS_COLORS[status] || STATUS_COLORS['Acompanhamento'] : STATUS_COLORS[status];
                const accumulatedDisplay = isNonNumeric ? accumulated : accumulated.toLocaleString('pt-BR');


                tableHTML += `
                    <tr>
                        <td class="sticky-left text-left font-semibold">
                            ${meta.id}. ${meta.title}
                            <p class="text-xs text-gray-500 mt-1 font-normal">${meta.targetText}</p>
                        </td>
                        <td>${isNonNumeric ? dataRow.set : dataRow.set.toLocaleString('pt-BR')}</td>
                        <td>${isNonNumeric ? dataRow.out : dataRow.out.toLocaleString('pt-BR')}</td>
                        <td>${isNonNumeric ? dataRow.nov : dataRow.nov.toLocaleString('pt-BR')}</td>
                        <td>${isNonNumeric ? dataRow.dez : dataRow.dez.toLocaleString('pt-BR')}</td>
                        <td class="font-bold">${accumulatedDisplay}</td>
                        <td class="font-bold ${statusColor.text} ${statusColor.bg} rounded-full text-xs py-1 px-3 whitespace-normal">${status}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            tableContent.innerHTML = tableHTML;
        }

        // L√ìGICA DE POEPS - Planejamento Anual
        
        function renderPoepsAnnualPlan(data) {
            const annualData = POEPS_PLANNING_DATA.camanducaia_poeps;
            const months = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            
            const tableContent = document.getElementById('poeps-annual-plan-content');
            
            let tableHTML = `
                <h4 class="text-lg font-bold text-gray-800 mb-4">Metas e A√ß√µes - Ano de 2025</h4>
                <div class="overflow-x-auto">
                    <table class="poeps-annual-table min-w-full">
                        <thead>
                            <tr>
                                <th class="sticky-left" rowspan="2">Indicador / Meta Anual</th>
                                <th colspan="4" class="bg-blue-200 text-blue-800">1¬∫ Quadrimestre</th>
                                <th colspan="4" class="bg-green-200 text-green-800">2¬∫ Quadrimestre</th>
                                <th colspan="4" class="bg-yellow-200 text-yellow-800">3¬∫ Quadrimestre</th>
                            </tr>
                            <tr>
                                ${months.map(m => `<th class="uppercase">${m}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            annualData.forEach(item => {
                 tableHTML += `
                    <tr>
                        <td class="sticky-left indicator-cell text-left">
                            ${item.id}. ${item.indicator}
                            <p class="text-xs text-gray-500 font-normal mt-1">${item.metaAnual}</p>
                        </td>
                        ${months.map(m => {
                            const monthData = item[m];
                            const isMeta = m === 'jan' || m === 'mai' || m === 'set'; // Simula o m√™s inicial de um quadrimestre
                            const bgColor = m === 'jan' || m === 'fev' || m === 'mar' || m === 'abr' ? 'bg-blue-50' : 
                                            m === 'mai' || m === 'jun' || m === 'jul' || m === 'ago' ? 'bg-green-50' : 'bg-yellow-50';
                            
                            return `
                                <td class="whitespace-normal text-left text-xs ${bgColor}">
                                    <p class="font-semibold">${monthData.tema}</p>
                                    <p class="text-gray-500 mt-1 italic">Resp: ${monthData.responsavel}</p>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                 `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-lg">
                    <p class="text-sm text-indigo-800 font-semibold">
                        Nota: Este √© um plano consolidado. As metas de "Participantes" e "Mensura√ß√µes" s√£o divididas por equipe para atingir o total mensal/quadrimestral.
                    </p>
                </div>
            `;
            tableContent.innerHTML = tableHTML;
        }

        // L√ìGICA PSE (Programa Sa√∫de na Escola)
        
        function renderPSETable(data) {
             document.getElementById('pse-current-team-name').innerText = data.teamName;
             
             // 1. Obt√©m os dados mockados para a equipe selecionada (esf_centro, esf_cruzeiro, etc.)
             const teamIdKey = currentTeamId;
             const teamPseData = CAMANDUCAIA_PSE_DATA[teamIdKey] || [];
             const tableBody = document.getElementById('pse-table-body');
             tableBody.innerHTML = ''; 

             if (teamPseData.length === 0) {
                 tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-gray-500">
                            Nenhuma a√ß√£o PSE encontrada para a equipe ${data.teamName} ou o munic√≠pio n√£o √© Camanducaia.
                        </td>
                    </tr>
                 `;
                 return;
             }
             
             // 2. Renderiza as linhas da tabela PSE
             let rowsHtml = '';
             teamPseData.forEach(item => {
                 rowsHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="border px-3 py-2 text-left font-medium text-gray-700 whitespace-normal">${item.escola || '--'}</td>
                        <td class="border px-3 py-2 text-left whitespace-normal max-w-xs">${item.acao || '--'}</td>
                        <td class="border px-3 py-2 text-left">${item.responsavel || '--'}</td>
                        <td class="border px-3 py-2 text-left whitespace-normal max-w-xs">${item.acoes_pse_correspondentes || '--'}</td>
                        <td class="border px-3 py-2 text-left text-xs text-gray-500">${item.registro || '--'}</td>
                    </tr>
                 `;
             });
             
             tableBody.innerHTML = rowsHtml;
        }


        // --- Initialization ---
        window.onload = initializeSetupFlow;

    </script>
</body>
</html>
